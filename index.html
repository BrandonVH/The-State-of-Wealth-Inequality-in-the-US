<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>The State of Wealth Inequality in the U.S.</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            body {
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                margin: 0;
                background: #0f0f0f;
                color: #eeeeee;
            }

            header {
                padding: 12px 20px;
                background: #1e1e1e;
                color: #ffffff;
                display:flex;
                align-items:center;
                gap:12px;
                border-bottom: 1px solid #333;
            }

            header h1 {
                font-size:18px;
                margin:0;
            }

            #container {
                padding: 16px;
                max-width:1200px;
                margin: 0 auto;
            }

            svg {
                width: 100%;
                height: 75vh;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            }

            .circle {
                stroke: rgba(255,255,255,0.25);
                stroke-width:0.7;
                opacity: 0.95;
                cursor: pointer;
            }

            .tooltip {
                position: absolute;
                pointer-events: none;
                padding: 6px 8px;
                font-size: 12px;
                background: rgba(20,20,20,0.9);
                color: #fff;
                border-radius: 6px;
                transform: translate(-50%, -120%);
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0,0,0,0.6);
                z-index: 10;
                border: 1px solid #444;
            }

            #legend div span {
                color: #ffffff;
                font-weight: 500;
            }

            .controls {
                margin-top: 12px;
                display:flex;
                gap:8px;
                align-items:center;
                flex-wrap:wrap;
            }

            button {
                padding: 8px 12px;
                border-radius: 6px;
                border: none;
                background: #333;
                color: #eee;
                cursor: pointer;
                font-weight: 600;
                border: 1px solid #555;
                transition: 0.15s;
            }

            button:hover {
                background: #444;
            }

            button.active {
                background: #ff7a00;
                color: #000;
                border-color: #ff7a00;
            }

            footer {
                margin-top: 16px;
                color: #aaa;
                font-size: 13px;
            }

            a {
                color: #4da3ff;
            }

            #year-controls {
                display: none;
                margin-top: 16px;
                padding: 16px;
                background: #1a1a1a;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            }

            #year-controls.active {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            #year-slider-container {
                display: flex;
                align-items: center;
                gap: 12px;
                width: 100%;
                max-width: 600px;
            }

            #year-slider {
                flex: 1;
                height: 6px;
                border-radius: 3px;
                background: #333;
                outline: none;
                -webkit-appearance: none;
            }

            #year-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #ff7a00;
                cursor: pointer;
            }

            #year-slider::-moz-range-thumb {
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #ff7a00;
                cursor: pointer;
                border: none;
                appearance: none;
                -moz-appearance: none;
            }

            #year-display {
                min-width: 80px;
                text-align: center;
                font-weight: 600;
                color: #fff;
            }

            #play-controls {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            #play-btn {
                padding: 8px 16px;
                border-radius: 6px;
                border: none;
                background: #333;
                color: #eee;
                cursor: pointer;
                font-weight: 600;
                border: 1px solid #555;
                transition: 0.15s;
            }

            #play-btn:hover {
                background: #444;
            }

            #play-btn.playing {
                background: #ff7a00;
                color: #000;
                border-color: #ff7a00;
            }

            /* Left/right navigation buttons beside the map */
            .nav-arrow {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 42px;
                height: 42px;
                background: #333;
                border: 1px solid #555;
                border-radius: 50%;
                color: #eee;
                font-size: 20px;
                font-weight: bold;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: 0.2s;
                z-index: 20;
            }

            .nav-arrow:hover {
                background: #444;
            }

            #nav-left {
                left: 12px;
            }

            #nav-right {
                right: 12px;
            }

            #map-container {
                position: relative;
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
            }

            /* Popup overlay */
            .popup {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.7);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }

            .popup-content {
                max-width: 650px;
                width: 90%;
                background: #1e1e1e;
                padding: 24px 28px;
                border-radius: 10px;
                border: 1px solid #555;
                line-height: 1.5;
            }

        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    </head>

    <body>
        <header>
            <h1>The State of Wealth Inequality in the U.S.</h1>
        </header>

        <div style="padding-bottom: 20px; max-width: 800px; margin: 0 auto; line-height: 1.5; padding-top: 30px;">

            <div id="description"></div>
        </div>

        <div id="map-title" style="
                text-align: center;
                margin: 10px 0;
                font-size: 20px;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            ">
        </div>

        <div id="map-container">
            <button class="nav-arrow" id="nav-left">‹</button>
            <svg id="map"></svg>
            <button class="nav-arrow" id="nav-right">›</button>
        </div>

        <div id="legend" style="
                justify-content: center;
                display: flex;
                gap: 14px;
                margin-top: 16px;
                flex-wrap: wrap;
            "></div>

        <div class="controls" style="justify-content: center; width: 100%;">
            <button id="btn0">Introduction</button>
            <button id="btnEdu">Education</button>
            <button id="btnAge">Age</button>
            <button id="btnInc">Income</button>
            <button id="btnGen">Generation</button>
            <button id="btnRace">Race</button>
            <button id="btnNW">Net Worth</button>
            <button id="btn6">Takeaway</button>
        </div>

        <div id="year-controls">
            <div id="year-slider-container">
                <span id="year-display">1989</span>
                <input type="range" id="year-slider" min="0" max="100" value="0" step="1">
            </div>
            <div id="play-controls">
                <button id="play-btn">▶ Play</button>
            </div>
        </div>

        <div id="tooltip" class="tooltip" style="display:none;"></div>

        <footer>
            Data sourced from
            <a href="https://www.federalreserve.gov/releases/z1/dataviz/dfa/distribute/chart/">
                Federal Reserve Z1 Data
            </a>
        </footer>

        <!-- Popup overlay; click anywhere to close -->
        <div id="popup" class="popup">
            <div id="popup-content" class="popup-content"></div>
        </div>

        <script>
            // GLOBAL VARIABLES
            let cachedStates = null;
            let raceData, ageData, incomeData, networthData, educationData, generationData;
            let dataReady = false;
            let networthYears = []; // Available years for net worth data
            let currentYearIndex = 0;
            let isPlaying = false;
            let playInterval = null;

            const svg = d3.select("#map");
            const projection = d3.geoAlbersUsa();
            const path = d3.geoPath(projection);
            const tooltip = d3.select("#tooltip");
            const description = document.querySelector("#description");
            const map_title = document.querySelector("#map-title");
            
            // popup elements
            const popupEl = document.getElementById("popup");
            const popupContentEl = document.getElementById("popup-content");
            let popupOpen = false;
            let introPopupShown = false; 


            function openPopup(html) {
                popupContentEl.innerHTML = `
                    ${html}
                    <div style="margin-top:12px; font-size:12px; color:#cccccc; opacity:0.9;">
                        Click anywhere or use right arrow to close this message.
                    </div>
                `;
                popupEl.style.display = "flex";
                popupOpen = true;
            }

            function closePopup() {
                popupEl.style.display = "none";
                popupOpen = false;
            }

            // click ANYWHERE on popup overlay to close
            popupEl.addEventListener("click", closePopup);


            // track which main view we're on
            let currentMainView = "intro";

            const incomeLabelMap = {
                pct99to100: "Top 1% (99–100th)",
                pct80to99: "80–99th percentile",
                pct60to80: "60–80th percentile",
                pct40to60: "40–60th percentile",
                pct20to40: "20–40th percentile",
                pct00to20: "0-20th percentile"
            };

            const ageLabelMap = {
                age70plus: "70 and older",
                age55to69: "55–69",
                age40to54: "40–54",
                ageunder40: "Under 40"
            };

            const introPopupHTML = `
                <strong>When it comes to the "American Dream", we often talk as if every American is afforded the same opportunities and potential.</strong>
                When most people imagine wealth distribution, they believe in fairness and fail to understand how dramatically unbalanced it truly is.
                Once we break differences down by race, age, income, education, and generation, we can begin to understand all the facets and patterns
                of wealth inequality. This visualization uses 1,000 dots to visually allocate American wealth into demographic groups by color.
            `;
            // transition popup text (from removed slides)
            const popupTexts = {
                
                eduToAge: `
                    <strong>We’ve looked at how education affects wealth.</strong>
                    But education alone doesn't explain why inequality looks the way it does. 
                    As you move to age, you’ll see how life stage and timing reshape the picture in a very different way.
                `,
                ageToInc: `
                    <strong>Income paints a different picture from both education and age.</strong>
                    Wealth doesn’t rise in a simple, proportional way with income categories. 
                    The next view shows how yearly earnings relate to who actually holds wealth.
                `,
                incToGen: `
                    <strong>Generational trends show us that economic timing matters.</strong>
                    Each generation entered adulthood under different housing markets, job prospects, and policies.
                    Moving to the generation view connects wealth to historical context.
                `,
                genToRace: `
                    <strong>Generations highlight big economic eras, but they don’t show how identity shapes opportunity.</strong>
                    The race view reveals some of the most dramatic and persistent differences in wealth holdings.
                `,
                raceToNW: `
                    <strong>Race reveals deep structural gaps in who holds wealth.</strong>
                    To bring everything together, the net worth view shows the overall structure of wealth inequality,
                    combining all of these forces into a single distribution.
                `,
                idealToReal: `
                    <strong>Before viewing the actual net worth distribution, let’s see what an equal America would look like.</strong>
                    Below is how wealth would be shared if the top 1%, top 10%, top 50%, and bottom 50% held wealth proportional 
                    to their population size. After closing this popup, you'll see how different the real distribution actually is.
                `
            };

            function getLabel(cat, dataset) {
                if (dataset === incomeData && incomeLabelMap[cat]) { 
                    return incomeLabelMap[cat];
                }
                if (dataset === ageData && ageLabelMap[cat]) {
                    return ageLabelMap[cat];
                }
                return cat;
            }

            Promise.all([
                d3.csv("data/dfa-race-levels.csv"),
                d3.csv("data/dfa-age-levels.csv"),
                d3.csv("data/dfa-income-levels.csv"),
                d3.csv("data/dfa-networth-levels.csv"),
                d3.csv("data/dfa-education-levels.csv"),
                d3.csv("data/dfa-generation-levels.csv")
            ])
            .then(([race, age, income, networth, education, generation]) => {
                raceData = race;
                ageData = age;
                incomeData = income;
                networthData = networth;
                educationData = education;
                generationData = generation;

                // Extract and sort unique years from networth data
                const yearSet = new Set(networth.map(d => d.Date.split(':')[0]));
                networthYears = Array.from(yearSet).sort((a, b) => parseInt(a) - parseInt(b));
                
                // Initialize slider
                const yearSlider = document.getElementById("year-slider");
                const yearDisplay = document.getElementById("year-display");
                yearSlider.max = networthYears.length - 1;
                yearSlider.value = 0; // Start at 1989 (earliest year)
                currentYearIndex = 0;
                updateYearDisplay();

                dataReady = true;
                console.log("All CSVs loaded successfully with Category column");
            });

            // RESIZE HANDLER
            window.addEventListener("resize", () => {
                if (!cachedStates) return;

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                projection.fitSize([width, height], cachedStates);

                svg.selectAll("circle")
                    .attr("cx", d => projection([d.lon, d.lat])[0])
                    .attr("cy", d => projection([d.lon, d.lat])[1]);
            });

            function updateLegend(categories, dataset, colorScale) {
                const legend = document.getElementById("legend");
                legend.innerHTML = "";

                categories.forEach(cat => {
                    const item = document.createElement("div");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "6px";

                    const swatch = document.createElement("div");
                    swatch.style.width = "14px";
                    swatch.style.height = "14px";
                    swatch.style.borderRadius = "3px";
                    swatch.style.backgroundColor = colorScale(cat);
                    swatch.style.border = "1px solid rgba(0,0,0,0.3)";

                    const label = document.createElement("span");
                    label.style.fontSize = "13px";
                    label.textContent = getLabel(cat, dataset);

                    item.appendChild(swatch);
                    item.appendChild(label);
                    legend.appendChild(item);
                });
            }

            // INITIAL DRAW OF 1000 DOTS
            function first_draw() {
                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
                    .then(usData => {
                        const states = topojson.feature(usData, usData.objects.states);
                        cachedStates = states;

                        projection.fitSize([width, height], states);

                        const bounds = path.bounds(states);
                        const [[x0, y0], [x1, y1]] = bounds;
                        const area = (x1 - x0) * (y1 - y0);

                        const targetDots = 1000;
                        const spacing = Math.sqrt(area / targetDots);

                        const points = [];
                        for (let x = x0; x <= x1; x += spacing) {
                            for (let y = y0; y <= y1; y += spacing) {
                                const inverted = projection.invert([x, y]);
                                if (inverted && d3.geoContains(states, inverted)) {
                                    points.push({ lon: inverted[0], lat: inverted[1] });
                                }
                            }
                        }

                        if (points.length > targetDots) points.length = targetDots;

                        svg.selectAll("circle")
                            .data(points)
                            .enter()
                            .append("circle")
                            .attr("class", "circle")
                            .attr("cx", d => projection([d.lon, d.lat])[0])
                            .attr("cy", d => projection([d.lon, d.lat])[1])
                            .attr("fill", "#888888")
                            .attr("r", 0)
                            .transition()
                            .duration(400)
                            .attr("r", 8);
                    });
            }
            first_draw();

            function updateDots(dataset, targetDate = null) {
                if (!dataset || dataset.length === 0) return;

                // 1. Use target date/year if specified, otherwise use latest date
                let selectedRows;
                if (targetDate) {
                    if (targetDate.includes(':')) {
                        selectedRows = dataset.filter(d => d.Date === targetDate);
                    } else {
                        if (dataset === networthData) {
                            selectedRows = dataset.filter(d => d.Date.startsWith(targetDate + ':'));
                        } else {
                            const yearPattern = new RegExp(`^${targetDate}:`);
                            const yearRows = dataset.filter(d => yearPattern.test(d.Date));
                            if (yearRows.length > 0) {
                                const firstQuarter = d3.min(yearRows, d => d.Date);
                                selectedRows = dataset.filter(d => d.Date === firstQuarter);
                            } else {
                                selectedRows = [];
                            }
                        }
                    }
                    if (selectedRows.length === 0) {
                        const latestDate = d3.max(dataset, d => d.Date);
                        selectedRows = dataset.filter(d => d.Date === latestDate);
                    }
                } else {
                    const latestDate = d3.max(dataset, d => d.Date);
                    selectedRows = dataset.filter(d => d.Date === latestDate);
                }
                let latestRows = selectedRows;

                latestRows.forEach(d => {
                    d.NetWorth = +d["Net worth"];
                });

                if (dataset === networthData) {
                    const groupMap = {
                        "TopPt1": "Top 1%",
                        "RemainingTop1": "Top 1%",
                        "Next9": "Next 9%",
                        "Next40": "Next 40%",
                        "Bottom50": "Bottom 50%"
                    };

                    if (targetDate && !targetDate.includes(':')) {
                        const byQuarter = d3.group(latestRows, d => d.Date);
                        const quarterlySums = [];
                        
                        byQuarter.forEach((quarterRows, date) => {
                            const quarterGrouped = d3.rollups(
                                quarterRows,
                                v => d3.sum(v, d => d.NetWorth),
                                d => groupMap[d.Category]
                            );
                            quarterlySums.push(...quarterGrouped.map(([Category, NetWorth]) => ({ Category, NetWorth, Date: date })));
                        });
                        
                        const byCategory = d3.rollups(
                            quarterlySums,
                            v => d3.mean(v, d => d.NetWorth),
                            d => d.Category
                        );
                        
                        latestRows = byCategory.map(([Category, NetWorth]) => ({ Category, NetWorth }));
                    } else {
                        const grouped = d3.rollups(
                            latestRows,
                            v => d3.sum(v, d => d.NetWorth),
                            d => groupMap[d.Category]
                        );

                        latestRows = grouped.map(([Category, NetWorth]) => ({ Category, NetWorth }));
                    }
                }

                const totalNetWorth = d3.sum(latestRows, d => d.NetWorth);
                const categories = latestRows.map(d => d.Category);
                const proportions = latestRows.map(d => d.NetWorth / totalNetWorth);

                const categoryPercentages = new Map();
                latestRows.forEach((row, idx) => {
                    categoryPercentages.set(row.Category, proportions[idx]);
                });

                let color;
                if (dataset === networthData) {
                    color = d3.scaleOrdinal()
                        .domain(categories)
                        .range(
                            categories.map(cat => {
                                if (cat === "Top 1%")     return "#d73027";
                                if (cat === "Next 9%")    return "#1a9850";
                                if (cat === "Next 40%")   return "#4575b4";
                                if (cat === "Bottom 50%") return "#fee08b";
                                return "#888888";
                            })
                        );
                } else {
                    const baseColors = ["#d73027", "#1a9850", "#4575b4", "#fee08b", "#fc8d59", "#91bfdb"];
                    color = d3.scaleOrdinal()
                        .domain(categories)
                        .range(baseColors.slice(0, categories.length));
                }

                const circlesSelection = svg.selectAll("circle");
                const nodes = circlesSelection.nodes();

                nodes.sort((a, b) => {
                    const ax = +a.getAttribute("cx");
                    const bx = +b.getAttribute("cx");
                    return ax - bx;
                });

                const totalDots = nodes.length;

                let counts = proportions.map(p => Math.max(1, Math.round(p * totalDots)));

                let sumCounts = counts.reduce((a, b) => a + b, 0);
                while (sumCounts !== totalDots) {
                    const diff = totalDots - sumCounts;
                    counts[0] += diff;
                    sumCounts = counts.reduce((a, b) => a + b, 0);
                }

                const bandCategories = [];
                latestRows.forEach((row, idx) => {
                    const cat = row.Category;
                    const n = counts[idx];
                    for (let i = 0; i < n; i++) {
                        bandCategories.push(cat);
                    }
                });

                nodes.forEach((node, i) => {
                    const sel = d3.select(node);
                    if (i < bandCategories.length) {
                        const cat = bandCategories[i];
                        node.__data__.Category = cat;
                        sel.attr("visibility", "visible");
                    } else {
                        sel.attr("visibility", "hidden");
                    }
                });

                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", d => color(d.Category));

                svg.selectAll("circle")
                    .on("mousemove", (event, d) => {
                        const label = getLabel(d.Category, dataset);
                        const percentage = categoryPercentages.get(d.Category);
                        const percentageText = percentage ? ` (${(percentage * 100).toFixed(1)}%)` : '';
                        tooltip.style("display", "block")
                            .style("left", event.pageX + "px")
                            .style("top", (event.pageY - 20) + "px")
                            .text(label + percentageText);
                    })
                    .on("mouseout", () => tooltip.style("display", "none"));

                updateLegend(categories, dataset, color);
            }

            // YEAR CONTROLS FUNCTIONS
            function updateYearDisplay() {
                const yearDisplay = document.getElementById("year-display");
                if (networthYears.length > 0 && currentYearIndex >= 0 && currentYearIndex < networthYears.length) {
                    const year = networthYears[currentYearIndex];
                    yearDisplay.textContent = year;
                }
            }

            function updateVisualizationForYear() {
                if (networthYears.length > 0 && currentYearIndex >= 0 && currentYearIndex < networthYears.length) {
                    const selectedYear = networthYears[currentYearIndex];
                    updateDots(networthData, selectedYear);
                    map_title.textContent = `Distribution of Wealth by Net Worth (${selectedYear})`;
                }
            }

            function togglePlay() {
                const playBtn = document.getElementById("play-btn");
                if (isPlaying) {
                    clearInterval(playInterval);
                    isPlaying = false;
                    playBtn.textContent = "▶ Play";
                    playBtn.classList.remove("playing");
                } else {
                    isPlaying = true;
                    playBtn.textContent = "⏸ Pause";
                    playBtn.classList.add("playing");
                    playInterval = setInterval(() => {
                        if (currentYearIndex < networthYears.length - 1) {
                            currentYearIndex++;
                            const yearSlider = document.getElementById("year-slider");
                            yearSlider.value = currentYearIndex;
                            updateYearDisplay();
                            updateVisualizationForYear();
                        } else {
                            togglePlay();
                        }
                    }, 300);
                }
            }

            // BUTTON & VIEW ORDER
            const datasetOrder = [
                { btn: "#btn0", view: "intro" },
                { btn: "#btnEdu", view: "edu" },
                { btn: "#btnAge", view: "age" },
                { btn: "#btnInc", view: "inc" },
                { btn: "#btnGen", view: "gen" },
                { btn: "#btnRace", view: "race" },
                { btn: "#btnNW", view: "nw" },
                { btn: "#btn6", view: "takeaway" }
            ];
            let currentViewIndex = null;

            function setActive(btnId) {
                currentViewIndex = datasetOrder.findIndex(d => d.btn === btnId);
                document.querySelectorAll(".controls button").forEach(b => b.classList.remove("active"));
                if (btnId) {
                    document.querySelector(btnId).classList.add("active");
                }
            }

            function hideYearControls() {
                const yearControls = document.getElementById("year-controls");
                yearControls.classList.remove("active");
                if (isPlaying) {
                    togglePlay();
                }
            }

            function showYearControls() {
                const yearControls = document.getElementById("year-controls");
                yearControls.classList.add("active");
            }

            document.getElementById("btn0").onclick = () => {
                const prev = currentMainView;
                currentMainView = "intro";
                setActive("#btn0");
                hideYearControls();

                // Remove text entirely
                description.innerHTML = "";
                map_title.textContent = "";

                // Hide ALL circles so no gray map appears
                svg.selectAll("circle")
                    .transition()
                    .duration(200)
                    .attr("visibility", "hidden");

                // Clear legend
                d3.select("#legend").selectAll("*").remove();

                // Optional: fade the whole SVG background darker (if you want a cleaner intro)
                svg.style("background", "none");

                // Show intro popup only once
                if (!introPopupShown) {
                    openPopup(introPopupHTML);
                    introPopupShown = true;
                }
            };




            // EDUCATION
            document.getElementById("btnEdu").onclick = () => {
                const prev = currentMainView;
                currentMainView = "edu";
                setActive("#btnEdu");
                hideYearControls();

                description.innerHTML = `
                    <strong>Many people begin with the belief that education neatly predicts financial outcomes.</strong>
                    Diplomas seem like clear markers of stability: high school, college, and graduate degrees appear to form 
                    a simple ladder of economic mobility. Yet when we map wealth across educational groups, the pattern 
                    becomes more complex. Even though additional schooling is associated with higher earnings, the wealth 
                    that households hold varies far more widely than expected. This first view suggests that education 
                    matters, but it is only the starting point for understanding how wealth actually accumulates in the U.S.
                `;
                map_title.textContent = "Distribution of Wealth by Education";
                updateDots(educationData);

            };

            // AGE
            document.getElementById("btnAge").onclick = () => {
                const prev = currentMainView;
                currentMainView = "age";
                setActive("#btnAge");
                hideYearControls();

                description.innerHTML = `
                <strong>Age adds a natural progression to the story, since people typically build assets as they grow 
                older.</strong> The data reveals this relationship is far from uniform. Younger and older groups hold vastly 
                different shares of national wealth, and the distribution doesn't mirror what we saw with education. This 
                contrast shows that wealth is shaped not just by personal achievements but by life stages, timing, and 
                long-term financial cycles. As we move beyond age, the picture becomes even less predictable.
                `;
                map_title.textContent = "Distribution of Wealth by Age";
                updateDots(ageData);

                if (prev === "edu") {
                    openPopup(popupTexts.eduToAge);
                }

            };

            // INCOME
            document.getElementById("btnInc").onclick = () => {
                const prev = currentMainView;
                currentMainView = "inc";
                setActive("#btnInc");
                hideYearControls();

                description.innerHTML = `
                    <strong>Income adds another familiar lens, since many assume higher earnings naturally lead to higher wealth.</strong>
                    But when we visualize the distribution, the pattern looks very different from what education or age suggested. 
                    Wealth does not rise proportionally with income categories. Instead, the spread shows that yearly earnings capture 
                    only one part of a household's financial position. This view highlights that income reflects what flows in each 
                    year, while wealth reflects what accumulates over many years.
                `;
                map_title.textContent = "Distribution of Wealth by Income";
                updateDots(incomeData);

                if (prev === "age") {
                    openPopup(popupTexts.ageToInc);
                }

            };

            // GENERATION
            document.getElementById("btnGen").onclick = () => {
                const prev = currentMainView;
                currentMainView = "gen";
                setActive("#btnGen");
                hideYearControls();

                description.innerHTML = `
                    <strong>Looking at generations shifts the story from individual circumstances to broader historical 
                    patterns.</strong> Each generation entered adulthood under different economic conditions, shaping the 
                    opportunities available to build and maintain wealth. Even though there are reasonably similar numbers of 
                    Americans within the Baby Boomer, Gen X, and Millenial generations, their share of wealth are drastically
                    different. The resulting distribution doesn't resemble the patterns of education, age, or income. It reflects 
                    the influence of economic eras, major shifts in policy, housing markets, and financial systems. This nuanced 
                    view shows that wealth is not only personal but also contextual.
                `;
                map_title.textContent = "Distribution of Wealth by Generation";
                updateDots(generationData);

                if (prev === "inc") {
                     openPopup(popupTexts.incToGen);
                }
            };

            // RACE
            document.getElementById("btnRace").onclick = () => {
                const prev = currentMainView;
                currentMainView = "race";
                setActive("#btnRace");
                hideYearControls();

                description.innerHTML = `
                    <strong>Examining wealth by racial groups reveals yet another pattern that reshapes our understanding 
                        of the data.</strong> Unlike the previous categories, this distribution reflects long-term demographic 
                        trends rather than life stages or income levels. For example, white Americans make up approximately 60%
                        of the U.S. population but hold over 84% of the country's wealth, setting them at a clearly disproportionate
                        advantage. Meanwhile, black Americans make up approximately 14% of the population but hold around 4% of the
                        country's wealth. The differences across racial groups highlight how identity contributes to national 
                        wealth shares and demonstrate that multiple identity and contextual factors push individuals into different
                        wealth opportunities. 
                `;
                map_title.textContent = "Distribution of Wealth by Race";
                updateDots(raceData);

                if (prev === "gen") {
                    openPopup(popupTexts.genToRace);
                }
            };

            // NET WORTH
            document.getElementById("btnNW").onclick = () => {
                const prev = currentMainView;
                currentMainView = "nw";
                setActive("#btnNW");
                showYearControls();

                description.innerHTML = `
                    <strong>With all perspectives in mind, the net worth view brings the entire story into focus.</strong>
                    Unlike the earlier dimensions, which revealed different slices of the population, this distribution shows 
                    the full structure of wealth in the U.S. at once. Use the slider below to explore how wealth distribution 
                    has changed over time from 1989 to the present. The play button will animate through the years automatically, 
                    revealing the evolution of wealth inequality. The red dots represent the top 1%, green the next 9%, blue the 
                    next 40%, and cream the bottom 50%. This visualization reveals how complex and interconnected the drivers of 
                    wealth truly are far beyond any single variable: Every part of an American's identity matters and influences 
                    how they are set up to hold wealth in America.
                `;

                if (networthYears.length > 0) {
                    currentYearIndex = 0;
                    const yearSlider = document.getElementById("year-slider");
                    if (yearSlider) {
                        yearSlider.value = 0;
                    }
                    updateYearDisplay();
                    const selectedYear = networthYears[0];
                    updateDots(networthData, selectedYear);
                    map_title.textContent = `Distribution of Wealth by Net Worth (${selectedYear})`;
                } else {
                    updateDots(networthData);
                    map_title.textContent = "Distribution of Wealth by Net Worth";
                }

                if (prev === "race") {
                    // 1) Show the new popup
                    openPopup(popupTexts.idealToReal);

                    // 2) Temporarily render an IDEAL distribution
                    showIdealNetWorthDistribution();

                    // 3) When user closes popup, animate into the REAL one
                    const originalClosePopup = closePopup;
                    closePopup = function () {
                        originalClosePopup();
                        // After popup closes → animate to REAL data
                        if (networthYears.length > 0) {
                            const selectedYear = networthYears[0];
                            updateDots(networthData, selectedYear);
                            map_title.textContent = `Distribution of Wealth by Net Worth (${selectedYear})`;
                        } else {
                            updateDots(networthData);
                            map_title.textContent = "Distribution of Wealth by Net Worth";
                        }
                        // Restore closePopup so other popups behave normally
                        closePopup = originalClosePopup;
                    };

                    return; // Prevent real view from loading immediately
                }

            };

            // TAKEAWAY
            document.getElementById("btn6").onclick = () => {
                const prev = currentMainView;
                currentMainView = "takeaway";
                setActive("#btn6");
                hideYearControls();

                description.innerHTML = `
                    <strong>What do all these categories show us?</strong><br>
                    That wealth inequality is the product of many overlapping forces — education, age, 
                    income, generation, and race all interact, compounding advantages for some groups 
                    while limiting opportunities for others. When we look at the extreme top of the
                    distribution, the concentration is especially stark.
                `;
                map_title.textContent = "Takeaway";

                const circles = svg.selectAll("circle").nodes();

                circles.sort((a, b) => +a.getAttribute("cx") - +b.getAttribute("cx"));

                const totalDots = circles.length;
                const redCount = Math.max(1, Math.round(totalDots * 0.01)); // 1%

                circles.forEach((circle, i) => {
                    d3.select(circle)
                    .transition()
                    .duration(400)
                    .attr("fill", i < redCount ? "#d73027" : "#1a9850");
                });

                d3.select("#legend").selectAll("*").remove();

                const entries = [
                    { color: "#d73027", label: "Top 1%" },
                    { color: "#1a9850", label: "Remaining 99%" }
                ];

                const legend = document.getElementById("legend");
                legend.innerHTML = "";

                entries.forEach(cat => {
                    const item = document.createElement("div");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "6px";

                    const swatch = document.createElement("div");
                    swatch.style.width = "14px";
                    swatch.style.height = "14px";
                    swatch.style.borderRadius = "3px";
                    swatch.style.backgroundColor = cat.color;
                    swatch.style.border = "1px solid rgba(0,0,0,0.3)";

                    const label = document.createElement("span");
                    label.style.fontSize = "13px";
                    label.textContent = cat.label;

                    item.appendChild(swatch);
                    item.appendChild(label);
                    legend.appendChild(item);
                });

            };

            // YEAR CONTROLS EVENT LISTENERS
            const yearSlider = document.getElementById("year-slider");
            const playBtn = document.getElementById("play-btn");

            if (yearSlider) {
                yearSlider.addEventListener("input", (e) => {
                    currentYearIndex = parseInt(e.target.value);
                    updateYearDisplay();
                    updateVisualizationForYear();
                    if (isPlaying) {
                        togglePlay();
                    }
                });
            }

            if (playBtn) {
                playBtn.addEventListener("click", togglePlay);
            }

            function showIdealNetWorthDistribution() {
                // Target equal proportions by population, not wealth
                // For example:
                // Top 1% → 1%
                // Next 9% → 9%
                // Next 40% → 40%
                // Bottom 50% → 50%

                const ideal = [
                    { Category: "Top 1%", proportion: 0.01 },
                    { Category: "Next 9%", proportion: 0.09 },
                    { Category: "Next 40%", proportion: 0.40 },
                    { Category: "Bottom 50%", proportion: 0.50 }
                ];

                const totalDots = svg.selectAll("circle").nodes().length;
                const counts = ideal.map(d => Math.round(d.proportion * totalDots));

                const categories = ideal.map(d => d.Category);
                const color = d3.scaleOrdinal()
                    .domain(categories)
                    .range(["#d73027", "#1a9850", "#4575b4", "#fee08b"]);

                // Turn these simple proportions into a fake dataset compatible with updateDots logic
                const fakeData = ideal.map((d, i) => ({
                    Category: d.Category,
                    NetWorth: d.proportion // arbitrary, just used for relative weights
                }));

                // Use existing update logic
                updateLegend(categories, fakeData, color);

                // Apply color bands
                const nodes = svg.selectAll("circle").nodes();
                nodes.sort((a, b) => +a.getAttribute("cx") - +b.getAttribute("cx"));

                let index = 0;
                nodes.forEach((node, i) => {
                    let cat;
                    if (i < counts[0]) cat = categories[0];
                    else if (i < counts[0] + counts[1]) cat = categories[1];
                    else if (i < counts[0] + counts[1] + counts[2]) cat = categories[2];
                    else cat = categories[3];

                    node.__data__.Category = cat;
                    d3.select(node)
                        .transition()
                        .duration(400)
                        .attr("fill", color(cat))
                        .attr("visibility", "visible");
                });

                map_title.textContent = "Equal (Ideal) Distribution of Wealth by Population Percentile";
            }


            // Arrow navigation (buttons)
            function updateViewFromArrows(indexChange) {
                if (currentViewIndex === null){
                    currentViewIndex = indexChange === 1 ? 0 : datasetOrder.length - 1;
                } else {
                    currentViewIndex = (currentViewIndex + indexChange + datasetOrder.length) % datasetOrder.length;
                }
                const entry = datasetOrder[currentViewIndex];
                const btn = document.querySelector(entry.btn);
                btn.click();
            }

            document.getElementById("nav-left").onclick = () => {
                if (popupOpen) {
                    closePopup();        // just dismiss popup; don’t change slide
                    return;
                }
                updateViewFromArrows(-1);
            };

            document.getElementById("nav-right").onclick = () => {
                if (popupOpen) {
                    closePopup();        // just dismiss popup; don’t change slide
                    return;
                }
                updateViewFromArrows(1);
            };


            // Arrow key navigation, but don't hijack when typing/using inputs
            document.addEventListener("keydown", (e) => {
                const tag = e.target.tagName;
                if (tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT") return;

                if (e.key === "ArrowRight") {
                    if (popupOpen) {
                        closePopup();    // close popup, don’t move slide
                        return;
                    }
                    updateViewFromArrows(1);
                } else if (e.key === "ArrowLeft") {
                    if (popupOpen) {
                        closePopup();    // close popup, don’t move slide
                        return;
                    }
                    updateViewFromArrows(-1);
                }
            });


            // Auto-load intro view
            const btn0 = document.getElementById("btn0");
            btn0.click();
        </script>

    </body>
</html>
