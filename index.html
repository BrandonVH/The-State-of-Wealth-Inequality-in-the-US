<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>The State of Wealth Inequality in the U.S.</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            body {
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                margin: 0;
                background: #0f0f0f;
                color: #eeeeee;
            }

            header {
                padding: 12px 20px;
                background: #1e1e1e;
                color: #ffffff;
                display:flex;
                align-items:center;
                gap:12px;
                border-bottom: 1px solid #333;
            }

            header h1 {
                font-size:18px;
                margin:0;
            }

            #container {
                padding: 16px;
                max-width:1200px;
                margin: 0 auto;
            }

            svg {
                width: 100%;
                height: 75vh;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            }

            .circle {
                stroke: rgba(255,255,255,0.25);
                stroke-width:0.7;
                opacity: 0.95;
                cursor: pointer;
            }

            .tooltip {
                position: absolute;
                pointer-events: none;
                padding: 6px 8px;
                font-size: 12px;
                background: rgba(20,20,20,0.9);
                color: #fff;
                border-radius: 6px;
                transform: translate(-50%, -120%);
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0,0,0,0.6);
                z-index: 10;
                border: 1px solid #444;
            }

            #legend div span {
                color: #ffffff;
                font-weight: 500;
            }

            .controls {
                margin-top: 12px;
                display:flex;
                gap:8px;
                align-items:center;
                flex-wrap:wrap;
            }

            button {
                padding: 8px 12px;
                border-radius: 6px;
                border: none;
                background: #333;
                color: #eee;
                cursor: pointer;
                font-weight: 600;
                border: 1px solid #555;
                transition: 0.15s;
            }

            button:hover {
                background: #444;
            }

            button.active {
                background: #ff7a00;
                color: #000;
                border-color: #ff7a00;
            }

            footer {
                margin-top: 16px;
                color: #aaa;
                font-size: 13px;
            }

            a {
                color: #4da3ff;
            }

            #year-controls {
                display: none;
                margin-top: 16px;
                padding: 16px;
                background: #1a1a1a;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            }

            #year-controls.active {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            #year-slider-container {
                display: flex;
                align-items: center;
                gap: 12px;
                width: 100%;
                max-width: 600px;
            }

            #year-slider {
                flex: 1;
                height: 6px;
                border-radius: 3px;
                background: #333;
                outline: none;
                -webkit-appearance: none;
            }

            #year-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #ff7a00;
                cursor: pointer;
            }

            #year-slider::-moz-range-thumb {
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #ff7a00;
                cursor: pointer;
                border: none;
                appearance: none;
                -moz-appearance: none;
            }

            #year-display {
                min-width: 80px;
                text-align: center;
                font-weight: 600;
                color: #fff;
            }

            #play-controls {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            #play-btn {
                padding: 8px 16px;
                border-radius: 6px;
                border: none;
                background: #333;
                color: #eee;
                cursor: pointer;
                font-weight: 600;
                border: 1px solid #555;
                transition: 0.15s;
            }

            #play-btn:hover {
                background: #444;
            }

            #play-btn.playing {
                background: #ff7a00;
                color: #000;
                border-color: #ff7a00;
            }

            /* Left/right navigation buttons beside the map */
            .nav-arrow {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 42px;
                height: 42px;
                background: #333;
                border: 1px solid #555;
                border-radius: 50%;
                color: #eee;
                font-size: 20px;
                font-weight: bold;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: 0.2s;
                z-index: 20;
            }

            .nav-arrow:hover {
                background: #444;
            }

            #nav-left {
                left: 12px;
            }

            #nav-right {
                right: 12px;
            }

            #map-container {
                position: relative;
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    </head>

    <body>
        <header>
            <h1>The State of Wealth Inequality in the U.S.</h1>
        </header>

        <div style="padding-bottom: 20px; max-width: 800px; margin: 0 auto; line-height: 1.5; padding-top: 30px;">

            <div id="description">
                <!-- When it comes to the "American Dream", we often talk as if every American is afforded the same opportunities and 
                potential. On the surface, the U.S. economy appears prosperous and fair, with the meritocractic belief that hard
                work alone can secure success. When most people imagine wealth distribution, they believe in fairness and fail to 
                understand how dramatically unbalanced it truly is. Once we break differences down by race, age, income, education, 
                and generation, we can begin to understand all the facets and patterns of wealth inequality. This visualization 
                uses 1,000 dots to visually allocate American wealth into demographic groups by color. Our project aims to make 
                complex economic inequality data accessible, visual, and meaningful for a general audience. -->
            </div>
        </div>

            <div id="map-title" style="
                text-align: center;
                margin: 10px 0;
                font-size: 20px;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            ">
                <!-- Click the “Education” button below to begin exploring how wealth is actually distributed in the United States. -->
            </div>

            <div id="map-container">
                <button class="nav-arrow" id="nav-left">‹</button>
                <txt id="transition-text"></txt>
                <svg id="map"></svg>
                <button class="nav-arrow" id="nav-right">›</button>
            </div>

            <div id="legend" style="
                justify-content: center;
                display: flex;
                gap: 14px;
                margin-top: 16px;
                flex-wrap: wrap;
            "></div>

            <div class="controls" style="justify-content: center; width: 100%;">
                <button id="btn0">Introduction</button>
                <button id="btnEdu">Education</button>
                <button id="btn1">1</button>
                <button id="btnAge">Age</button>
                <button id="btn2">2</button>
                <button id="btnInc">Income</button>
                <button id="btn3">3</button>
                <button id="btnGen">Generation</button>
                <button id="btn4">4</button>
                <button id="btnRace">Race</button>
                <button id="btn5">5</button>
                <button id="btnNW">Net Worth</button>
                <button id="btn6">Takeaway</button>
            </div>

            <div id="year-controls">
                <div id="year-slider-container">
                    <span id="year-display">1989</span>
                    <input type="range" id="year-slider" min="0" max="100" value="0" step="1">
                </div>
                <div id="play-controls">
                    <button id="play-btn">▶ Play</button>
                </div>
            </div>

            <div id="tooltip" class="tooltip" style="display:none;"></div>

            <!--
            <section id="writeup" style="max-width: 900px; margin: 40px auto; line-height: 1.6; padding: 20px;">
                <h3>1. What have you done so far?</h3>
                <p>
                    So far, we've built the full structure of the interactive visualization, including the U.S. map layout,
                    point-generation system, and the dynamic dot-redistribution algorithm. We connected the interface to the most
                    recent year from six different Federal Reserve Z1 datasets (race, age, income, net worth, education, and generation).
                    We also implemented button navigation so that each dataset can be displayed instantly, with color-coded categories, 
                    a responsive legend, and dynamic tooltips that update as the user moves between views. Altogether, the page is fully 
                    functional and allows users to explore major dimensions of wealth inequality through an intuitive and engaging interface.
                </p>

                <h3>2. What will be the most challenging part of your project to design and why?</h3>
                <p>
                    The most challenging part of the project will be creating a clear and meaningful visual narrative that helps users 
                    interpret inequality data rather than simply displaying it. Wealth distribution is complex and users need guidance
                    to understand the significance behind the numbers and categories. Another challenge will be managing layout constraints such 
                    as keeping text, buttons, and the visualization properly aligned on different screen sizes while keeping the visuals clear, 
                    because poor alignment or spacing can confuse users and reduce the effectiveness of the data presentation across devices. It 
                    will also be difficult to ensure that every demographic group receives appropriate visual weight without overwhelming the viewer.
                    If we're not careful,disproportionate scaling or color emphasis can accidentally exaggerate or minimize certain disparities, 
                    leading to misinterpretation.
                </p>
            </section>
            -->

            <footer>
                Data sourced from
                <a href="https://www.federalreserve.gov/releases/z1/dataviz/dfa/distribute/chart/">
                    Federal Reserve Z1 Data
                </a>
            </footer>
        </div>


        <script>

            // GLOBAL VARIABLES
            let cachedStates = null;
            let raceData, ageData, incomeData, networthData, educationData, generationData;
            let dataReady = false;
            let networthYears = []; // Available years for net worth data
            let currentYearIndex = 0;
            let isPlaying = false;
            let playInterval = null;

            const svg = d3.select("#map");
            const projection = d3.geoAlbersUsa();
            const path = d3.geoPath(projection);
            const tooltip = d3.select("#tooltip");
            const description = document.querySelector("#description");
            const map_title = document.querySelector("#map-title");

            const incomeLabelMap = {
                pct99to100: "Top 1% (99–100th)",
                pct80to99: "80–99th percentile",
                pct60to80: "60–80th percentile",
                pct40to60: "40–60th percentile",
                pct20to40: "20–40th percentile",
                pct00to20: "0-20th percentile"
            };

            const ageLabelMap = {
                age70plus: "70 and older",
                age55to69: "55–69",
                age40to54: "40–54",
                ageunder40: "Under 40"
            };

            function getLabel(cat, dataset) {
                if (dataset === incomeData && incomeLabelMap[cat]) { 
                    return incomeLabelMap[cat];
                }
                if (dataset === ageData && ageLabelMap[cat]) {
                    return ageLabelMap[cat];
                }
                return cat;
            }

            Promise.all([
                d3.csv("data/dfa-race-levels.csv"),
                d3.csv("data/dfa-age-levels.csv"),
                d3.csv("data/dfa-income-levels.csv"),
                d3.csv("data/dfa-networth-levels.csv"),
                d3.csv("data/dfa-education-levels.csv"),
                d3.csv("data/dfa-generation-levels.csv")
            ])
            .then(([race, age, income, networth, education, generation]) => {
                raceData = race;
                ageData = age;
                incomeData = income;
                networthData = networth;
                educationData = education;
                generationData = generation;

                // Extract and sort unique years from networth data
                const yearSet = new Set(networth.map(d => d.Date.split(':')[0]));
                networthYears = Array.from(yearSet).sort((a, b) => parseInt(a) - parseInt(b));
                
                // Initialize slider
                const yearSlider = document.getElementById("year-slider");
                const yearDisplay = document.getElementById("year-display");
                yearSlider.max = networthYears.length - 1;
                yearSlider.value = 0; // Start at 1989 (earliest year)
                currentYearIndex = 0;
                updateYearDisplay();

                dataReady = true;
                console.log("All CSVs loaded successfully with Category column");
            });


            // RESIZE HANDLER
            window.addEventListener("resize", () => {
                if (!cachedStates) return;

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                projection.fitSize([width, height], cachedStates);

                svg.selectAll("circle")
                    .attr("cx", d => projection([d.lon, d.lat])[0])
                    .attr("cy", d => projection([d.lon, d.lat])[1]);
            });

            function updateLegend(categories, dataset, colorScale) {
                const legend = document.getElementById("legend");
                legend.innerHTML = "";

                categories.forEach(cat => {
                    const item = document.createElement("div");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "6px";

                    const swatch = document.createElement("div");
                    swatch.style.width = "14px";
                    swatch.style.height = "14px";
                    swatch.style.borderRadius = "3px";
                    swatch.style.backgroundColor = colorScale(cat);
                    swatch.style.border = "1px solid rgba(0,0,0,0.3)";

                    const label = document.createElement("span");
                    label.style.fontSize = "13px";
                    label.textContent = getLabel(cat, dataset);  // ⬅ use pretty label

                    item.appendChild(swatch);
                    item.appendChild(label);
                    legend.appendChild(item);
                });
            }


            // INITIAL DRAW OF 1000 DOTS
            function first_draw() {

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
                    .then(usData => {

                        const states = topojson.feature(usData, usData.objects.states);
                        cachedStates = states;

                        projection.fitSize([width, height], states);

                        const bounds = path.bounds(states);
                        const [[x0, y0], [x1, y1]] = bounds;
                        const area = (x1 - x0) * (y1 - y0);

                        const targetDots = 1000;
                        const spacing = Math.sqrt(area / targetDots);

                        const points = [];
                        for (let x = x0; x <= x1; x += spacing) {
                            for (let y = y0; y <= y1; y += spacing) {
                                const inverted = projection.invert([x, y]);
                                if (inverted && d3.geoContains(states, inverted)) {
                                    points.push({ lon: inverted[0], lat: inverted[1] });
                                }
                            }
                        }

                        if (points.length > targetDots) points.length = targetDots;

                        svg.selectAll("circle")
                            .data(points)
                            .enter()
                            .append("circle")
                            .attr("class", "circle")
                            .attr("cx", d => projection([d.lon, d.lat])[0])
                            .attr("cy", d => projection([d.lon, d.lat])[1])
                            .attr("fill", "#888888")
                            .attr("r", 0)
                            .transition()
                            .duration(400)
                            .attr("r", 8);
                    });
            }

            first_draw();


            function updateDots(dataset, targetDate = null) {

                if (!dataset || dataset.length === 0) return;

                // 1. Use target date/year if specified, otherwise use latest date
                let selectedRows;
                if (targetDate) {
                    // Check if targetDate is a year (just digits) or a full date (contains colon)
                    if (targetDate.includes(':')) {
                        // It's a full date (e.g., "1989:Q3")
                        selectedRows = dataset.filter(d => d.Date === targetDate);
                    } else {
                        // It's a year (e.g., "1989")
                        if (dataset === networthData) {
                            // For net worth, filter all quarters for this year
                            selectedRows = dataset.filter(d => d.Date.startsWith(targetDate + ':'));
                        } else {
                            // For other datasets, find first quarter of that year
                            const yearPattern = new RegExp(`^${targetDate}:`);
                            const yearRows = dataset.filter(d => yearPattern.test(d.Date));
                            if (yearRows.length > 0) {
                                const firstQuarter = d3.min(yearRows, d => d.Date);
                                selectedRows = dataset.filter(d => d.Date === firstQuarter);
                            } else {
                                selectedRows = [];
                            }
                        }
                    }
                    if (selectedRows.length === 0) {
                        // Fallback to latest if date/year not found
                        const latestDate = d3.max(dataset, d => d.Date);
                        selectedRows = dataset.filter(d => d.Date === latestDate);
                    }
                } else {
                    const latestDate = d3.max(dataset, d => d.Date);
                    selectedRows = dataset.filter(d => d.Date === latestDate);
                }
                let latestRows = selectedRows;

                // 2. Parse Net worth as numeric
                latestRows.forEach(d => {
                    d.NetWorth = +d["Net worth"];
                });

                if (dataset === networthData) {
                    const groupMap = {
                        "TopPt1": "Top 1%",
                        "RemainingTop1": "Top 1%",
                        "Next9": "Next 9%",
                        "Next40": "Next 40%",
                        "Bottom50": "Bottom 50%"
                    };

                    // If we have multiple quarters (yearly average), average the values
                    if (targetDate && !targetDate.includes(':')) {
                        // First, sum by category within each quarter
                        const byQuarter = d3.group(latestRows, d => d.Date);
                        const quarterlySums = [];
                        
                        byQuarter.forEach((quarterRows, date) => {
                            const quarterGrouped = d3.rollups(
                                quarterRows,
                                v => d3.sum(v, d => d.NetWorth),
                                d => groupMap[d.Category]
                            );
                            quarterlySums.push(...quarterGrouped.map(([Category, NetWorth]) => ({ Category, NetWorth, Date: date })));
                        });
                        
                        // Now average across quarters for each category
                        const byCategory = d3.rollups(
                            quarterlySums,
                            v => d3.mean(v, d => d.NetWorth),
                            d => d.Category
                        );
                        
                        latestRows = byCategory.map(([Category, NetWorth]) => ({ Category, NetWorth }));
                    } else {
                        // Single quarter - just sum by category
                        const grouped = d3.rollups(
                            latestRows,
                            v => d3.sum(v, d => d.NetWorth),
                            d => groupMap[d.Category]
                        );

                        // Rebuild as simple array of {Category, NetWorth}
                        latestRows = grouped.map(([Category, NetWorth]) => ({ Category, NetWorth }));
                    }
                }

                // 4. Compute totals, categories, proportions
                const totalNetWorth = d3.sum(latestRows, d => d.NetWorth);
                const categories = latestRows.map(d => d.Category);
                const proportions = latestRows.map(d => d.NetWorth / totalNetWorth);
                
                // Create a map of category to percentage for tooltip
                const categoryPercentages = new Map();
                latestRows.forEach((row, idx) => {
                    categoryPercentages.set(row.Category, proportions[idx]);
                });

                // 5. Color scale
                let color;

                if (dataset === networthData) {
                    // Explicit colors for grouped net-worth categories - using same palette as other visualizations
                    color = d3.scaleOrdinal()
                        .domain(categories)
                        .range(
                            categories.map(cat => {
                                if (cat === "Top 1%")     return "#d73027";  // top 1% – red
                                if (cat === "Next 9%")    return "#1a9850";  // next 9% – green
                                if (cat === "Next 40%")   return "#4575b4";  // next 40% – blue

                                if (cat === "Bottom 50%") return "#fee08b";  // bottom half – cream

                                return "#888888"; // fallback
                            })
                        );
                } else {
                    // Default palette for other dimensions
                    const baseColors = ["#d73027", "#1a9850", "#4575b4", "#fee08b", "#fc8d59", "#91bfdb"];
                    color = d3.scaleOrdinal()
                        .domain(categories)
                        .range(baseColors.slice(0, categories.length));
                }

                // 6. Get all circles and sort them by x-position
                const circlesSelection = svg.selectAll("circle");
                const nodes = circlesSelection.nodes();

                nodes.sort((a, b) => {
                    const ax = +a.getAttribute("cx");
                    const bx = +b.getAttribute("cx");
                    return ax - bx;
                });

                const totalDots = nodes.length;

                // 7. Decide how many dots each category gets (at least 1 each)
                let counts = proportions.map(p => Math.max(1, Math.round(p * totalDots)));

                let sumCounts = counts.reduce((a, b) => a + b, 0);
                while (sumCounts !== totalDots) {
                    const diff = totalDots - sumCounts;
                    counts[0] += diff;
                    sumCounts = counts.reduce((a, b) => a + b, 0);
                }

                // 8. Build a flat list of categories for each dot (in band order)
                const bandCategories = [];
                latestRows.forEach((row, idx) => {
                    const cat = row.Category;
                    const n = counts[idx];
                    for (let i = 0; i < n; i++) {
                        bandCategories.push(cat);
                    }
                });

                // 9. Assign categories to dots according to x-sorted order
                nodes.forEach((node, i) => {
                    const sel = d3.select(node);
                    if (i < bandCategories.length) {
                        const cat = bandCategories[i];
                        node.__data__.Category = cat;
                        sel.attr("visibility", "visible");
                    } else {
                        sel.attr("visibility", "hidden");
                    }
                });

                // 10. Animate colors
                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", d => color(d.Category));

                // 11. Tooltip
                svg.selectAll("circle")
                    .on("mousemove", (event, d) => {
                        const label = getLabel(d.Category, dataset);
                        const percentage = categoryPercentages.get(d.Category);
                        const percentageText = percentage ? ` (${(percentage * 100).toFixed(1)}%)` : '';
                        tooltip.style("display", "block")
                            .style("left", event.pageX + "px")
                            .style("top", (event.pageY - 20) + "px")
                            .text(label + percentageText);
                    })
                    .on("mouseout", () => tooltip.style("display", "none"));

                // 12. Legend (now uses grouped categories for net worth)
                updateLegend(categories, dataset, color);
            }


            // YEAR CONTROLS FUNCTIONS
            function updateYearDisplay() {
                const yearDisplay = document.getElementById("year-display");
                if (networthYears.length > 0 && currentYearIndex >= 0 && currentYearIndex < networthYears.length) {
                    const year = networthYears[currentYearIndex];
                    yearDisplay.textContent = year;
                }
            }

            function updateVisualizationForYear() {
                if (networthYears.length > 0 && currentYearIndex >= 0 && currentYearIndex < networthYears.length) {
                    const selectedYear = networthYears[currentYearIndex];
                    updateDots(networthData, selectedYear);
                    map_title.textContent = `Distribution of Wealth by Net Worth (${selectedYear})`;
                }
            }

            function togglePlay() {
                const playBtn = document.getElementById("play-btn");
                if (isPlaying) {
                    // Stop playing
                    clearInterval(playInterval);
                    isPlaying = false;
                    playBtn.textContent = "▶ Play";
                    playBtn.classList.remove("playing");
                } else {
                    // Start playing
                    isPlaying = true;
                    playBtn.textContent = "⏸ Pause";
                    playBtn.classList.add("playing");
                    playInterval = setInterval(() => {
                        if (currentYearIndex < networthYears.length - 1) {
                            currentYearIndex++;
                            const yearSlider = document.getElementById("year-slider");
                            yearSlider.value = currentYearIndex;
                            updateYearDisplay();
                            updateVisualizationForYear();
                        } else {
                            // Reached the end, stop playing
                            togglePlay();
                        }
                    }, 300); // Update every 300ms
                }
            }

            // BUTTON HANDLERS
            function setActive(btnId) {
                currentViewIndex = datasetOrder.findIndex(d => d.btn === btnId);
                document.querySelectorAll(".controls button").forEach(b => b.classList.remove("active"));
                if (btnId) {
                    document.querySelector(btnId).classList.add("active");
                }
            }

            function hideYearControls() {
                const yearControls = document.getElementById("year-controls");
                yearControls.classList.remove("active");
                if (isPlaying) {
                    togglePlay(); // Stop playing if switching away
                }
            }

            function showYearControls() {
                const yearControls = document.getElementById("year-controls");
                yearControls.classList.add("active");
            }

            document.getElementById("btnEdu").onclick = () => {
                setActive("#btnEdu");
                hideYearControls();
                description.innerHTML = `
                    <strong>Many people begin with the belief that education neatly predicts financial outcomes.</strong>
                    Diplomas seem like clear markers of stability: high school, college, and graduate degrees appear to form 
                    a simple ladder of economic mobility. Yet when we map wealth across educational groups, the pattern 
                    becomes more complex. Even though additional schooling is associated with higher earnings, the wealth 
                    that households hold varies far more widely than expected. This first view suggests that education 
                    matters, but it is only the starting point for understanding how wealth actually accumulates in the U.S.
                `;
                map_title.textContent = "Distribution of Wealth by Education";
                updateDots(educationData);
            };

            document.getElementById("btnAge").onclick = () => {
                setActive("#btnAge");
                hideYearControls();
                description.innerHTML = `
                <strong>Age adds a natural progression to the story, since people typically build assets as they grow 
                older.</strong> The data reveals this relationship is far from uniform. Younger and older groups hold vastly 
                different shares of national wealth, and the distribution doesn't mirror what we saw with education. This 
                contrast shows that wealth is shaped not just by personal achievements but by life stages, timing, and 
                long-term financial cycles. As we move beyond age, the picture becomes even less predictable.
                `;
                map_title.textContent = "Distribution of Wealth by Age";
                updateDots(ageData);
            };

            document.getElementById("btnInc").onclick = () => {
                setActive("#btnInc");
                hideYearControls();
                description.innerHTML = `
                    <strong>Income adds another familiar lens, since many assume higher earnings naturally lead to higher wealth.</strong>
                    But when we visualize the distribution, the pattern looks very different from what education or age suggested. 
                    Wealth does not rise proportionally with income categories. Instead, the spread shows that yearly earnings capture 
                    only one part of a household's financial position. This view highlights that income reflects what flows in each 
                    year, while wealth reflects what accumulates over many years.
                `;
                map_title.textContent = "Distribution of Wealth by Income";
                updateDots(incomeData);
            };

            document.getElementById("btnGen").onclick = () => {
                setActive("#btnGen");
                hideYearControls();
                description.innerHTML = `
                    <strong>Looking at generations shifts the story from individual circumstances to broader historical 
                    patterns.</strong> Each generation entered adulthood under different economic conditions, shaping the 
                    opportunities available to build and maintain wealth. Even though there are reasonably similar numbers of 
                    Americans within the Baby Boomer, Gen X, and Millenial generations, their share of wealth are drastically
                    different. The resulting distribution doesn't resemble the patterns of education, age, or income. It reflects 
                    the influence of economic eras, major shifts in policy, housing markets, and financial systems. This nuanced 
                    view shows that wealth is not only personal but also contextual.
                `;
                map_title.textContent = "Distribution of Wealth by Generation";
                updateDots(generationData);
            };

            document.getElementById("btnRace").onclick = () => {
                setActive("#btnRace");
                hideYearControls();
                description.innerHTML = `
                    <strong>Examining wealth by racial groups reveals yet another pattern that reshapes our understanding 
                        of the data.</strong> Unlike the previous categories, this distribution reflects long-term demographic 
                        trends rather than life stages or income levels. For example, white Americans make up approximately 60%
                        of the U.S. population but hold over 84% of the country's wealth, setting them at a clearly disproportionate
                        advantage. Meanwhile, black Americans make up approximately 14% of the population but hold around 4% of the
                        country's wealth. The differences across racial groups highlight how identity contributes to national 
                        wealth shares and demonstrate that multiple identity and contextual factors push individuals into different
                        wealth opportunities. 
                `;
                map_title.textContent = "Distribution of Wealth by Race";
                updateDots(raceData);
            };

            document.getElementById("btnNW").onclick = () => {
                setActive("#btnNW");
                showYearControls();
                description.innerHTML = `
                    <strong>With all perspectives in mind, the net worth view brings the entire story into focus.</strong>
                    Unlike the earlier dimensions, which revealed different slices of the population, this distribution shows 
                    the full structure of wealth in the U.S. at once. Use the slider below to explore how wealth distribution 
                    has changed over time from 1989 to the present. The play button will animate through the years automatically, 
                    revealing the evolution of wealth inequality. The red dots represent the top 1%, green the next 9%, blue the 
                    next 40%, and cream the bottom 50%. This visualization reveals how complex and interconnected the drivers of 
                    wealth truly are far beyond any single variable: Every part of an American's identity matters and influences 
                    how they are set up to hold wealth in America.
                `;
                // Reset to 1989 (earliest year)
                if (networthYears.length > 0) {
                    currentYearIndex = 0;
                    const yearSlider = document.getElementById("year-slider");
                    if (yearSlider) {
                        yearSlider.value = 0;
                    }
                    updateYearDisplay();
                    const selectedYear = networthYears[0];
                    updateDots(networthData, selectedYear);
                    map_title.textContent = `Distribution of Wealth by Net Worth (${selectedYear})`;
                } else {
                    updateDots(networthData);
                    map_title.textContent = "Distribution of Wealth by Net Worth";
                }
            };

            // --- INTRO & TRANSITION BUTTONS (0–6) ---
            document.getElementById("btn0").onclick = () => {
                setActive("#btn0");
                hideYearControls();
                description.innerHTML = `
                    <strong>When it comes to the "American Dream", we often talk as if every American is afforded the same opportunities and 
                    potential.</strong> On the surface, the U.S. economy appears prosperous and fair, with the meritocractic belief that hard
                    work alone can secure success. When most people imagine wealth distribution, they believe in fairness and fail to 
                    understand how dramatically unbalanced it truly is. Once we break differences down by race, age, income, education, 
                    and generation, we can begin to understand all the facets and patterns of wealth inequality. This visualization 
                    uses 1,000 dots to visually allocate American wealth into demographic groups by color. Our project aims to make 
                    complex economic inequality data accessible, visual, and meaningful for a general audience.
                `;
                map_title.textContent = "Introduction";

                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", "#888888");

                d3.select("#legend").selectAll("*").remove();
            };

            document.getElementById("btn1").onclick = () => {
                setActive("#btn1");
                hideYearControls();
                description.innerHTML = `
                    <strong>We’ve looked at how education affects wealth.</strong>
                    But education alone doesn't explain why inequality looks the way it does. 
                    Let’s keep exploring other dimensions to see how the patterns shift.
                `;
                map_title.textContent = "Transition";

                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", "#888888");

                d3.select("#legend").selectAll("*").remove();
            };

            document.getElementById("btn2").onclick = () => {
                setActive("#btn2");
                hideYearControls();
                description.innerHTML = `
                    <strong>Income paints a different picture from both education and age.</strong>
                    Now we'll move forward to see how generational differences reshape our understanding
                    of wealth distribution in America.
                `;
                map_title.textContent = "Transition";

                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", "#888888");

                d3.select("#legend").selectAll("*").remove();
            };

            document.getElementById("btn3").onclick = () => {
                setActive("#btn3");
                hideYearControls();
                description.innerHTML = `
                    <strong>Generational trends show us that economic timing matters.</strong>
                    But identity matters too. Now let's examine how wealth breaks down across racial groups.
                `;
                map_title.textContent = "Transition";

                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", "#888888");

                d3.select("#legend").selectAll("*").remove();
            };

            document.getElementById("btn4").onclick = () => {
                setActive("#btn4");
                hideYearControls();
                description.innerHTML = `
                    <strong>Race reveals some of the most dramatic differences in the data.</strong>
                    Next, we will bring all perspectives together by looking at overall net worth distribution.
                `;
                map_title.textContent = "Transition";

                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", "#888888");

                d3.select("#legend").selectAll("*").remove();
            };

            document.getElementById("btn5").onclick = () => {
                setActive("#btn5");
                hideYearControls();
                description.innerHTML = `
                    <strong>The net worth view showed us the structure of wealth inequality directly.</strong>
                    Now let's move toward concluding insights about what these patterns tell us.
                `;
                map_title.textContent = "Transition";

                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", "#888888");

                d3.select("#legend").selectAll("*").remove();
            };

            document.getElementById("btn6").onclick = () => {
                setActive("#btn6");
                hideYearControls();
                description.innerHTML = `
                    <strong>What does this visualization ultimately show?</strong><br>
                    Across all of the views, a consistent pattern emerges: the top 1% makes up a very small share of the population, 
                    yet holds roughly 30% of the country’s total wealth. In the net worth view, the red dots representing the top 1% 
                    regularly account for about one-third of national wealth, while the remaining 99% of Americans share everything 
                    that is left. This gap is much larger than what many people imagine when they think about the “American Dream.”
                    <br><br>
                    Taken together, the different dimensions in our visualization such as education, age, income, generation, and race
                    show that wealth inequality is built up over time through overlapping advantages and barriers. The takeaway is 
                    that a very small group starts with and maintains a highly concentrated share of wealth, while most households 
                    are competing over a much smaller portion of the economic pie.
                `;
                map_title.textContent = "Takeaway";

                // Select all circles
                const circles = svg.selectAll("circle").nodes();

                // Sort by x-position (left to right)
                circles.sort((a, b) => +a.getAttribute("cx") - +b.getAttribute("cx"));

                const totalDots = circles.length;
                const redCount = Math.max(1, Math.round(totalDots * 0.01)); // 1% of total

                // Apply fill colors with transition
                circles.forEach((circle, i) => {
                    d3.select(circle)
                    .transition()
                    .duration(400)
                    .attr("fill", i < redCount ? "#d73027" : "#1a9850");
                });

                // Clear legend
                d3.select("#legend").selectAll("*").remove();

                const entries = [
                    { color: "#d73027", label: "Top 1%" },
                    { color: "#1a9850", label: "Remaining 99%" }
                ];

                const legend = document.getElementById("legend");
                legend.innerHTML = "";

                entries.forEach(cat => {
                    const item = document.createElement("div");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "6px";

                    const swatch = document.createElement("div");
                    swatch.style.width = "14px";
                    swatch.style.height = "14px";
                    swatch.style.borderRadius = "3px";
                    swatch.style.backgroundColor = cat.color;
                    swatch.style.border = "1px solid rgba(0,0,0,0.3)";

                    const label = document.createElement("span");
                    label.style.fontSize = "13px";
                    label.textContent = cat.label;

                    item.appendChild(swatch);
                    item.appendChild(label);
                    legend.appendChild(item);
                });
            };

            // YEAR CONTROLS EVENT LISTENERS
            const yearSlider = document.getElementById("year-slider");
            const playBtn = document.getElementById("play-btn");

            if (yearSlider) {
                yearSlider.addEventListener("input", (e) => {
                    currentYearIndex = parseInt(e.target.value);
                    updateYearDisplay();
                    updateVisualizationForYear();
                    // Stop playing if user manually moves slider
                    if (isPlaying) {
                        togglePlay();
                    }
                });
            }

            if (playBtn) {
                playBtn.addEventListener("click", togglePlay);
            }

            // ORDER of datasets shown by arrows
            const datasetOrder = [
                { btn: "#btn0", title: "Intro" }, // TODO

                { btn: "#btnEdu", title: "Distribution of Wealth by Education" },

                { btn: "#btn1", title: "Transition 1" }, // TODO

                { btn: "#btnAge", title: "Distribution of Wealth by Age" },

                { btn: "#btn2", title: "Transition 2" }, // TODO

                { btn: "#btnInc", title: "Distribution of Wealth by Income" },

                { btn: "#btn3", title: "Transition 3" }, // TODO

                { btn: "#btnGen", title: "Distribution of Wealth by Generation" },

                { btn: "#btn4", title: "Transition 4" }, // TODO

                { btn: "#btnRace", title: "Distribution of Wealth by Race" },

                { btn: "#btn5", title: "Transition 5" }, // TODO

                { btn: "#btnNW", title: "Distribution of Wealth by Net Worth" },

                { btn: "#btn6", title: "Takeaway" } // TODO
            ];

            let currentViewIndex = null;

            function updateViewFromArrows(indexChange) {
                if (currentViewIndex === null){
                    currentViewIndex = indexChange === 1 ? 0 : datasetOrder.length - 1;
                }
                else{
                    currentViewIndex = (currentViewIndex + indexChange + datasetOrder.length) % datasetOrder.length;
                }

                const entry = datasetOrder[currentViewIndex];
                const btn = document.querySelector(entry.btn);

                btn.click(); // trigger existing behavior
            }

            // Arrow click listeners
            document.getElementById("nav-left").onclick = () => updateViewFromArrows(-1);
            document.getElementById("nav-right").onclick = () => updateViewFromArrows(1);

            function showCenteredDescription(descHTML) {
                // 1. Hide the SVG
                d3.select("#map").style("display", "none");

                // 2. Remove any existing centered text
                d3.select("#map-container").selectAll(".centered-text").remove();

                // 3. Append new centered text
                d3.select("#map-container")
                .append("div")
                .attr("class", "centered-text")
                .html(descHTML);
            }

            function hideCenteredDescription() {
                // Show SVG again
                d3.select("#map").style("display", "block");

                // Remove centered text
                d3.select("#map-container").selectAll(".centered-text").remove();
            }


            // BUTTON 0 SHOULD BE AUTOMATICALLY CLICKED WHEN PAGE LOADS
            btn0 = document.getElementById("btn0")
            btn0.click() 


        </script>

    </body>
</html>