<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>The State of Wealth Inequality in the U.S.</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            body {
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                margin: 0;
                background: #f7f9fc;
                color: #111;
            }
            header {
                padding: 12px 20px;
                background: #0b5cff;
                color: white;
                display:flex;
                align-items:center;
                gap:12px;
            }
            header h1 {
                font-size:18px;
                margin:0;
            }
            #container {
                padding: 16px;
                max-width:1200px;
                margin: 0 auto;
            }
            svg {
                width: 100%;
                height: 75vh;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(12,20,40,0.08);
                background: linear-gradient(180deg, #ffffff 0%, #fcfdff 100%);
            }
            .circle {
                stroke: rgba(0,0,0,0.2);
                stroke-width:0.7;
                opacity: 0.9;
                cursor: pointer;
            }
            .tooltip {
                position: absolute;
                pointer-events: none;
                padding: 6px 8px;
                font-size: 12px;
                background: rgba(0,0,0,0.8);
                color: white;
                border-radius: 6px;
                transform: translate(-50%, -120%);
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                z-index: 10;
            }
            .controls {
                margin-top: 12px;
                display:flex;
                gap:8px;
                align-items:center;
                flex-wrap:wrap;
            }
            button {
                padding: 8px 12px;
                border-radius: 6px;
                border: none;
                background: #0b5cff;
                color: white;
                cursor: pointer;
                font-weight: 600;
            }
            button.active {
                background: #ff7a00;
            }
            footer {
                margin-top: 16px;
                color: #555;
                font-size: 13px;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    </head>

    <body>
        <header>
            <h1>The State of Wealth Inequality in the U.S.</h1>
        </header>

        <div id="container">
            <div id="description" style="padding-bottom: 20px">
                Welcome to our interactive visualization about wealth inequality in America.
                Click on button 1 to get started.
            </div>

            <svg id="map"></svg>

            <div id="legend" style="
                display: flex;
                gap: 14px;
                margin-top: 16px;
                flex-wrap: wrap;
            "></div>

            <div class="controls">
                <button id="btn1">1</button>
                <button id="btn2">2</button>
                <button id="btn3">3</button>
                <button id="btn4">4</button>
                <button id="btn5">5</button>
                <button id="btn6">6</button>
            </div>

            <div id="tooltip" class="tooltip" style="display:none;"></div>

            <footer>
                Data sourced from
                <a href="https://www.federalreserve.gov/releases/z1/dataviz/dfa/distribute/chart/">
                    Federal Reserve Z1 Data
                </a>
            </footer>
        </div>


        <script>

            // GLOBAL VARIABLES
            let cachedStates = null;
            let raceData, ageData, incomeData, networthData, educationData, generationData;
            let dataReady = false;

            const svg = d3.select("#map");
            const projection = d3.geoAlbersUsa();
            const path = d3.geoPath(projection);
            const tooltip = d3.select("#tooltip");
            const description = document.querySelector("#description");


            Promise.all([
                d3.csv("data/dfa-race-levels.csv"),
                d3.csv("data/dfa-age-levels.csv"),
                d3.csv("data/dfa-income-levels.csv"),
                d3.csv("data/dfa-networth-levels.csv"),
                d3.csv("data/dfa-education-levels.csv"),
                d3.csv("data/dfa-generation-levels.csv")
            ])
            .then(([race, age, income, networth, education, generation]) => {
                raceData = race;
                ageData = age;
                incomeData = income;
                networthData = networth;
                educationData = education;
                generationData = generation;

                dataReady = true;
                console.log("All CSVs loaded successfully with Category column");
            });


            // RESIZE HANDLER
            window.addEventListener("resize", () => {
                if (!cachedStates) return;

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                projection.fitSize([width, height], cachedStates);

                svg.selectAll("circle")
                    .attr("cx", d => projection([d.lon, d.lat])[0])
                    .attr("cy", d => projection([d.lon, d.lat])[1]);
            });

            function updateLegend(categories, colorScale) {
                const legend = document.getElementById("legend");
                legend.innerHTML = "";  // clear previous legend

                categories.forEach(cat => {
                    const item = document.createElement("div");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "6px";

                    const swatch = document.createElement("div");
                    swatch.style.width = "14px";
                    swatch.style.height = "14px";
                    swatch.style.borderRadius = "3px";
                    swatch.style.backgroundColor = colorScale(cat);
                    swatch.style.border = "1px solid rgba(0,0,0,0.3)";

                    const label = document.createElement("span");
                    label.style.fontSize = "13px";
                    label.style.color = "#333";
                    label.textContent = cat;

                    item.appendChild(swatch);
                    item.appendChild(label);
                    legend.appendChild(item);
                });
            }

            // INITIAL DRAW OF 1000 DOTS
            function first_draw() {

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
                    .then(usData => {

                        const states = topojson.feature(usData, usData.objects.states);
                        cachedStates = states;

                        projection.fitSize([width, height], states);

                        const bounds = path.bounds(states);
                        const [[x0, y0], [x1, y1]] = bounds;
                        const area = (x1 - x0) * (y1 - y0);

                        const targetDots = 1000;
                        const spacing = Math.sqrt(area / targetDots);

                        const points = [];
                        for (let x = x0; x <= x1; x += spacing) {
                            for (let y = y0; y <= y1; y += spacing) {
                                const inverted = projection.invert([x, y]);
                                if (inverted && d3.geoContains(states, inverted)) {
                                    points.push({ lon: inverted[0], lat: inverted[1] });
                                }
                            }
                        }

                        if (points.length > targetDots) points.length = targetDots;

                        svg.selectAll("circle")
                            .data(points)
                            .enter()
                            .append("circle")
                            .attr("class", "circle")
                            .attr("cx", d => projection([d.lon, d.lat])[0])
                            .attr("cy", d => projection([d.lon, d.lat])[1])
                            .attr("fill", "#6fa3d6")
                            .attr("r", 0)
                            .transition()
                            .duration(400)
                            .attr("r", 3);
                    });
            }

            first_draw();


            // UPDATE DOT COLORS BASED ON Category COLUMN
            function updateDots(dataset) {

                if (!dataset || dataset.length === 0) return;

                // Only use the latest date
                const latestDate = d3.max(dataset, d => d.Date);
                const latestRows = dataset.filter(d => d.Date === latestDate);

                latestRows.forEach(d => d.NetWorth = +d["Net worth"]);

                const total = d3.sum(latestRows, d => d.NetWorth);

                const totalRows = dataset.length;
                latestRows.forEach(d => {
                    d.rowCount = Math.round((d.NetWorth / total) * totalRows);
                });

                // Fix rounding so totalRows is exact
                let assigned = d3.sum(latestRows, d => d.rowCount);
                while (assigned !== totalRows) {
                    const diff = totalRows - assigned;
                    latestRows[0].rowCount += diff;
                    assigned = d3.sum(latestRows, d => d.rowCount);
                }

                const rowCategories = [];
                latestRows.forEach(row => {
                    for (let i = 0; i < row.rowCount; i++) {
                        rowCategories.push(row.Category);
                    }
                });

                // Shuffle so the map is not striped
                for (let i = rowCategories.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [rowCategories[i], rowCategories[j]] = [rowCategories[j], rowCategories[i]];
                }

                const categories = latestRows.map(d => d.Category);

                const color = d3.scaleOrdinal()
                    .domain(categories)
                    .range(["#d73027", "#1a9850", "#4575b4", "#fee08b", "#fc8d59", "#91bfdb"]);

                const circles = svg.selectAll("circle");

                circles.each(function(d, i) {
                    if (i < rowCategories.length) {
                        d.Category = rowCategories[i];
                        d3.select(this).attr("visibility", "visible");
                    } else {
                        d3.select(this).attr("visibility", "hidden");
                    }
                });

                // Color transition
                circles.transition()
                    .duration(400)
                    .attr("fill", d => color(d.Category));

                // Tooltip
                circles.on("mousemove", (event, d) => {
                    tooltip.style("display", "block")
                        .style("left", event.pageX + "px")
                        .style("top", (event.pageY - 20) + "px")
                        .text(d.Category);
                });

                circles.on("mouseout", () => tooltip.style("display", "none"));

                // Legend
                updateLegend(categories, color);
            }


            // BUTTON HANDLERS
            function setActive(btnId) {
                document.querySelectorAll(".controls button").forEach(b => b.classList.remove("active"));
                document.querySelector(btnId).classList.add("active");
            }

            btn1.onclick = () => {
                setActive("#btn1");
                description.textContent = "Race distribution of wealth.";
                updateDots(raceData);
            };

            btn2.onclick = () => {
                setActive("#btn2");
                description.textContent = "Age distribution of wealth.";
                updateDots(ageData);
            };

            btn3.onclick = () => {
                setActive("#btn3");
                description.textContent = "Income distribution of wealth.";
                updateDots(incomeData);
            };

            btn4.onclick = () => {
                setActive("#btn4");
                description.textContent = "Net worth distribution of wealth.";
                updateDots(networthData);
            };

            btn5.onclick = () => {
                setActive("#btn5");
                description.textContent = "Education distribution of wealth.";
                updateDots(educationData);
            };

            btn6.onclick = () => {
                setActive("#btn6");
                description.textContent = "Generational distribution of wealth.";
                updateDots(generationData);
            };

        </script>

    </body>
</html>