<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>The State of Wealth Inequality in the U.S.</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            body {
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                margin: 0;
                background: #0f0f0f;
                color: #eeeeee;
            }

            header {
                padding: 12px 20px;
                background: #1e1e1e;
                color: #ffffff;
                display:flex;
                align-items:center;
                gap:12px;
                border-bottom: 1px solid #333;
            }

            header h1 {
                font-size:18px;
                margin:0;
            }

            #container {
                padding: 16px;
                max-width:1200px;
                margin: 0 auto;
            }

            svg {
                width: 100%;
                height: 75vh;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            }

            .circle {
                stroke: rgba(255,255,255,0.25);
                stroke-width:0.7;
                opacity: 0.95;
                cursor: pointer;
            }

            .tooltip {
                position: absolute;
                pointer-events: none;
                padding: 6px 8px;
                font-size: 12px;
                background: rgba(20,20,20,0.9);
                color: #fff;
                border-radius: 6px;
                transform: translate(-50%, -120%);
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0,0,0,0.6);
                z-index: 10;
                border: 1px solid #444;
            }

            #legend div span {
                color: #ffffff;
                font-weight: 500;
            }

            .controls {
                margin-top: 12px;
                display:flex;
                gap:8px;
                align-items:center;
                flex-wrap:wrap;
            }

            button {
                padding: 8px 12px;
                border-radius: 6px;
                border: none;
                background: #333;
                color: #eee;
                cursor: pointer;
                font-weight: 600;
                border: 1px solid #555;
                transition: 0.15s;
            }

            button:hover {
                background: #444;
            }

            button.active {
                background: #ff7a00;
                color: #000;
                border-color: #ff7a00;
            }

            footer {
                margin-top: 16px;
                color: #aaa;
                font-size: 13px;
            }

            a {
                color: #4da3ff;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    </head>

    <body>
        <header>
            <h1>The State of Wealth Inequality in the U.S.</h1>
        </header>

        <div style="padding-bottom: 20px; max-width: 800px; margin: 0 auto; line-height: 1.5; padding-top: 30px;">

            <div id="description">
                Wealth inequality in the United States has widened in the past decades.
                This interactive visualization breaks down distributions across multiple demographic dimensions in the United States using 
                Federal Reserve Z1 data. Through each filter, users can explore how wealth is distributed across major 
                demographic categories, including race, age, income, net worth, education, and generation. 
                Each view dynamically reallocates 1,000 dots to reflect the share of total household wealth held by each group 
                according to color-coded categories and tooltips. Our project aims to make complex economic
                inequality data accessible, visual, and meaningful for a general audience.
            </div>
        </div>

            <div id="map-title" style="
                text-align: center;
                margin: 10px 0;
                font-size: 30px;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            ">
                Welcome to our interactive visualization about wealth inequality in America.
                Click on button 1 to get started.
            </div>

            <svg id="map"></svg>

            <div id="legend" style="
                justify-content: center;
                display: flex;
                gap: 14px;
                margin-top: 16px;
                flex-wrap: wrap;
            "></div>

            <div class="controls" style="justify-content: center; width: 100%;">
                <button id="btn1">1</button>
                <button id="btn2">2</button>
                <button id="btn3">3</button>
                <button id="btn4">4</button>
                <button id="btn5">5</button>
                <button id="btn6">6</button>
            </div>

            <div id="tooltip" class="tooltip" style="display:none;"></div>

            <section id="writeup" style="max-width: 900px; margin: 40px auto; line-height: 1.6; padding: 20px;">
                <h3>1. What have you done so far?</h3>
                <p>
                    So far, we've built the full structure of the interactive visualization, including the U.S. map layout,
                    point-generation system, and the dynamic dot-redistribution algorithm. We connected the interface to the most
                    recent year from six different Federal Reserve Z1 datasets (race, age, income, net worth, education, and generation).
                    We also implemented button navigation so that each dataset can be displayed instantly, with color-coded categories, 
                    a responsive legend, and dynamic tooltips that update as the user moves between views. Altogether, the page is fully 
                    functional and allows users to explore major dimensions of wealth inequality through an intuitive and engaging interface.
                </p>

                <h3>2. What will be the most challenging part of your project to design and why?</h3>
                <p>
                    The most challenging part of the project will be creating a clear and meaningful visual narrative that helps users 
                    interpret inequality data rather than simply displaying it. Wealth distribution is complex and users need guidance
                    to understand the significance behind the numbers and categories. Another challenge will be managing layout constraints such 
                    as keeping text, buttons, and the visualization properly aligned on different screen sizes while keeping the visuals clear, 
                    because poor alignment or spacing can confuse users and reduce the effectiveness of the data presentation across devices. It 
                    will also be difficult to ensure that every demographic group receives appropriate visual weight without overwhelming the viewer.
                    If we're not careful,disproportionate scaling or color emphasis can accidentally exaggerate or minimize certain disparities, 
                    leading to misinterpretation.
                </p>
            </section>

            <footer>
                Data sourced from
                <a href="https://www.federalreserve.gov/releases/z1/dataviz/dfa/distribute/chart/">
                    Federal Reserve Z1 Data
                </a>
            </footer>
        </div>


        <script>

            // GLOBAL VARIABLES
            let cachedStates = null;
            let raceData, ageData, incomeData, networthData, educationData, generationData;
            let dataReady = false;

            const svg = d3.select("#map");
            const projection = d3.geoAlbersUsa();
            const path = d3.geoPath(projection);
            const tooltip = d3.select("#tooltip");
            const description = document.querySelector("#description");
            const map_title = document.querySelector("#map-title");

            Promise.all([
                d3.csv("data/dfa-race-levels.csv"),
                d3.csv("data/dfa-age-levels.csv"),
                d3.csv("data/dfa-income-levels.csv"),
                d3.csv("data/dfa-networth-levels.csv"),
                d3.csv("data/dfa-education-levels.csv"),
                d3.csv("data/dfa-generation-levels.csv")
            ])
            .then(([race, age, income, networth, education, generation]) => {
                raceData = race;
                ageData = age;
                incomeData = income;
                networthData = networth;
                educationData = education;
                generationData = generation;

                dataReady = true;
                console.log("All CSVs loaded successfully with Category column");
            });


            // RESIZE HANDLER
            window.addEventListener("resize", () => {
                if (!cachedStates) return;

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                projection.fitSize([width, height], cachedStates);

                svg.selectAll("circle")
                    .attr("cx", d => projection([d.lon, d.lat])[0])
                    .attr("cy", d => projection([d.lon, d.lat])[1]);
            });

            function updateLegend(categories, colorScale) {
                const legend = document.getElementById("legend");
                legend.innerHTML = "";

                categories.forEach(cat => {
                    const item = document.createElement("div");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "6px";

                    const swatch = document.createElement("div");
                    swatch.style.width = "14px";
                    swatch.style.height = "14px";
                    swatch.style.borderRadius = "3px";
                    swatch.style.backgroundColor = colorScale(cat);
                    swatch.style.border = "1px solid rgba(0,0,0,0.3)";

                    const label = document.createElement("span");
                    label.style.fontSize = "13px";
                    label.textContent = cat;

                    item.appendChild(swatch);
                    item.appendChild(label);
                    legend.appendChild(item);
                });
            }

            // INITIAL DRAW OF 1000 DOTS
            function first_draw() {

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
                    .then(usData => {

                        const states = topojson.feature(usData, usData.objects.states);
                        cachedStates = states;

                        projection.fitSize([width, height], states);

                        const bounds = path.bounds(states);
                        const [[x0, y0], [x1, y1]] = bounds;
                        const area = (x1 - x0) * (y1 - y0);

                        const targetDots = 1000;
                        const spacing = Math.sqrt(area / targetDots);

                        const points = [];
                        for (let x = x0; x <= x1; x += spacing) {
                            for (let y = y0; y <= y1; y += spacing) {
                                const inverted = projection.invert([x, y]);
                                if (inverted && d3.geoContains(states, inverted)) {
                                    points.push({ lon: inverted[0], lat: inverted[1] });
                                }
                            }
                        }

                        if (points.length > targetDots) points.length = targetDots;

                        svg.selectAll("circle")
                            .data(points)
                            .enter()
                            .append("circle")
                            .attr("class", "circle")
                            .attr("cx", d => projection([d.lon, d.lat])[0])
                            .attr("cy", d => projection([d.lon, d.lat])[1])
                            .attr("fill", "#6fa3d6")
                            .attr("r", 0)
                            .transition()
                            .duration(400)
                            .attr("r", 8);
                    });
            }

            first_draw();


            function updateDots(dataset) {

                if (!dataset || dataset.length === 0) return;

                // Only use the latest date
                const latestDate = d3.max(dataset, d => d.Date);
                const latestRows = dataset.filter(d => d.Date === latestDate);

                // Parse Net worth and compute proportions
                latestRows.forEach(d => d.NetWorth = +d["Net worth"]);
                const totalNetWorth = d3.sum(latestRows, d => d.NetWorth);

                const categories = latestRows.map(d => d.Category);
                const proportions = latestRows.map(d => d.NetWorth / totalNetWorth);

                // Color scale
                const color = d3.scaleOrdinal()
                    .domain(categories)
                    .range(["#d73027", "#1a9850", "#4575b4", "#fee08b", "#fc8d59", "#91bfdb"]);

                // Get all circles and sort them by x-position
                const circlesSelection = svg.selectAll("circle");
                const nodes = circlesSelection.nodes();

                nodes.sort((a, b) => {
                    const ax = +a.getAttribute("cx");
                    const bx = +b.getAttribute("cx");
                    return ax - bx;
                });

                const totalDots = nodes.length;

                // Decide how many dots each category gets (at least 1 each)
                let counts = proportions.map(p => Math.max(1, Math.round(p * totalDots)));

                let sumCounts = counts.reduce((a, b) => a + b, 0);
                while (sumCounts !== totalDots) {
                    const diff = totalDots - sumCounts;
                    counts[0] += diff;
                    sumCounts = counts.reduce((a, b) => a + b, 0);
                }

                // Build a flat list of categories for each dot (in band order)
                const bandCategories = [];
                latestRows.forEach((row, idx) => {
                    const cat = row.Category;
                    const n = counts[idx];
                    for (let i = 0; i < n; i++) {
                        bandCategories.push(cat);
                    }
                });

                // 7. Assign categories to dots according to x-sorted order
                nodes.forEach((node, i) => {
                    const sel = d3.select(node);
                    if (i < bandCategories.length) {
                        const cat = bandCategories[i];
                        node.__data__.Category = cat;
                        sel.attr("visibility", "visible");
                    } else {
                        sel.attr("visibility", "hidden");
                    }
                });

                // Animate colors
                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", d => color(d.Category));

                // Tooltip
                svg.selectAll("circle")
                    .on("mousemove", (event, d) => {
                        tooltip.style("display", "block")
                            .style("left", event.pageX + "px")
                            .style("top", (event.pageY - 20) + "px")
                            .text(d.Category);
                    })
                    .on("mouseout", () => tooltip.style("display", "none"));

                // Legend
                updateLegend(categories, color);
            }


            // BUTTON HANDLERS
            function setActive(btnId) {
                document.querySelectorAll(".controls button").forEach(b => b.classList.remove("active"));
                document.querySelector(btnId).classList.add("active");
            }

            btn1.onclick = () => {
                setActive("#btn1");
                description.textContent = "Race distribution of wealth.";
                map_title.textContent = "Distribution of Wealth by Race";
                updateDots(raceData);
            };

            btn2.onclick = () => {
                setActive("#btn2");
                description.textContent = "Age distribution of wealth.";
                map_title.textContent = "Distribution of Wealth by Age";
                updateDots(ageData);
            };

            btn3.onclick = () => {
                setActive("#btn3");
                description.textContent = "Income distribution of wealth.";
                map_title.textContent = "Distribution of Wealth by Income";
                updateDots(incomeData);
            };

            btn4.onclick = () => {
                setActive("#btn4");
                description.textContent = "Net worth distribution of wealth.";
                map_title.textContent = "Distribution of Wealth by Net Worth";
                updateDots(networthData);
            };

            btn5.onclick = () => {
                setActive("#btn5");
                description.textContent = "Education distribution of wealth.";
                map_title.textContent = "Distribution of Wealth by Education";
                updateDots(educationData);
            };

            btn6.onclick = () => {
                setActive("#btn6");
                description.textContent = "Generational distribution of wealth.";
                map_title.textContent = "Distribution of Wealth by Generation";
                updateDots(generationData);
            };

        </script>

    </body>
</html>