<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>The State of Wealth Inequality in the U.S.</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            body {
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                margin: 0;
                background: #0f0f0f;
                color: #eeeeee;
            }

            header {
                padding: 12px 20px;
                background: #1e1e1e;
                color: #ffffff;
                display:flex;
                align-items:center;
                gap:12px;
                border-bottom: 1px solid #333;
            }

            header h1 {
                font-size:18px;
                margin:0;
            }

            #container {
                padding: 16px;
                max-width:1200px;
                margin: 0 auto;
            }

            svg {
                width: 100%;
                height: 75vh;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            }

            .circle {
                stroke: rgba(255,255,255,0.25);
                stroke-width:0.7;
                opacity: 0.95;
                cursor: pointer;
            }

            .tooltip {
                position: absolute;
                pointer-events: none;
                padding: 6px 8px;
                font-size: 12px;
                background: rgba(20,20,20,0.9);
                color: #fff;
                border-radius: 6px;
                transform: translate(-50%, -120%);
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0,0,0,0.6);
                z-index: 10;
                border: 1px solid #444;
            }

            #legend div span {
                color: #ffffff;
                font-weight: 500;
            }

            .controls {
                margin-top: 12px;
                display:flex;
                gap:8px;
                align-items:center;
                flex-wrap:wrap;
            }

            button {
                padding: 8px 12px;
                border-radius: 6px;
                border: none;
                background: #333;
                color: #eee;
                cursor: pointer;
                font-weight: 600;
                border: 1px solid #555;
                transition: 0.15s;
            }

            button:hover {
                background: #444;
            }

            button.active {
                background: #ff7a00;
                color: #000;
                border-color: #ff7a00;
            }

            footer {
                margin-top: 16px;
                color: #aaa;
                font-size: 13px;
            }

            a {
                color: #4da3ff;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    </head>

    <body>
        <header>
            <h1>The State of Wealth Inequality in the U.S.</h1>
        </header>

        <div style="padding-bottom: 20px; max-width: 800px; margin: 0 auto; line-height: 1.5; padding-top: 30px;">

            <div id="description">
                When it comes to the "American Dream", we often talk as if every American is afforded the same opportunities and 
                potential. On the surface, the U.S. economy appears prosperous and fair, with the meritocractic belief that hard
                work alone can secure success. When most people imagine wealth distribution, they believe in fairness and fail to 
                understand how dramatically unbalanced it truly is. Once we break differences down by race, age, income, education, 
                and generation, we can begin to understand all the facets and patterns of wealth inequality. This visualization 
                uses 1,000 dots to visually allocate American wealth into demographic groups by color. Our project aims to make 
                complex economic inequality data accessible, visual, and meaningful for a general audience.
            </div>
        </div>

            <div id="map-title" style="
                text-align: center;
                margin: 10px 0;
                font-size: 20px;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.8);
                background: #1a1a1a;
            ">
                Click the “Education” button below to begin exploring how wealth is actually distributed in the United States.
            </div>

            <svg id="map"></svg>

            <div id="legend" style="
                justify-content: center;
                display: flex;
                gap: 14px;
                margin-top: 16px;
                flex-wrap: wrap;
            "></div>

            <div class="controls" style="justify-content: center; width: 100%;">
                <button id="btnEdu">Education</button>
                <button id="btnAge">Age</button>
                <button id="btnInc">Income</button>
                <button id="btnGen">Generation</button>
                <button id="btnRace">Race</button>
                <button id="btnNW">Net Worth</button>
                <button id="btnNW1989">Net Worth (1989)</button>
            </div>

            <div id="tooltip" class="tooltip" style="display:none;"></div>

            <section id="writeup" style="max-width: 900px; margin: 40px auto; line-height: 1.6; padding: 20px;">
                <h3>1. What have you done so far?</h3>
                <p>
                    So far, we've built the full structure of the interactive visualization, including the U.S. map layout,
                    point-generation system, and the dynamic dot-redistribution algorithm. We connected the interface to the most
                    recent year from six different Federal Reserve Z1 datasets (race, age, income, net worth, education, and generation).
                    We also implemented button navigation so that each dataset can be displayed instantly, with color-coded categories, 
                    a responsive legend, and dynamic tooltips that update as the user moves between views. Altogether, the page is fully 
                    functional and allows users to explore major dimensions of wealth inequality through an intuitive and engaging interface.
                </p>

                <h3>2. What will be the most challenging part of your project to design and why?</h3>
                <p>
                    The most challenging part of the project will be creating a clear and meaningful visual narrative that helps users 
                    interpret inequality data rather than simply displaying it. Wealth distribution is complex and users need guidance
                    to understand the significance behind the numbers and categories. Another challenge will be managing layout constraints such 
                    as keeping text, buttons, and the visualization properly aligned on different screen sizes while keeping the visuals clear, 
                    because poor alignment or spacing can confuse users and reduce the effectiveness of the data presentation across devices. It 
                    will also be difficult to ensure that every demographic group receives appropriate visual weight without overwhelming the viewer.
                    If we're not careful,disproportionate scaling or color emphasis can accidentally exaggerate or minimize certain disparities, 
                    leading to misinterpretation.
                </p>
            </section>

            <footer>
                Data sourced from
                <a href="https://www.federalreserve.gov/releases/z1/dataviz/dfa/distribute/chart/">
                    Federal Reserve Z1 Data
                </a>
            </footer>
        </div>


        <script>

            // GLOBAL VARIABLES
            let cachedStates = null;
            let raceData, ageData, incomeData, networthData, educationData, generationData;
            let dataReady = false;

            const svg = d3.select("#map");
            const projection = d3.geoAlbersUsa();
            const path = d3.geoPath(projection);
            const tooltip = d3.select("#tooltip");
            const description = document.querySelector("#description");
            const map_title = document.querySelector("#map-title");

            const incomeLabelMap = {
                pct99to100: "Top 1% (99–100th)",
                pct80to99: "80–99th percentile",
                pct60to80: "60–80th percentile",
                pct40to60: "40–60th percentile",
                pct20to40: "20–40th percentile",
                pct00to20: "0-20th percentile"
            };

            const ageLabelMap = {
                age70plus: "70 and older",
                age55to69: "55–69",
                age40to54: "40–54",
                ageunder40: "Under 40"
            };

            function getLabel(cat, dataset) {
                if (dataset === incomeData && incomeLabelMap[cat]) { 
                    return incomeLabelMap[cat];
                }
                if (dataset === ageData && ageLabelMap[cat]) {
                    return ageLabelMap[cat];
                }
                return cat;
            }

            Promise.all([
                d3.csv("data/dfa-race-levels.csv"),
                d3.csv("data/dfa-age-levels.csv"),
                d3.csv("data/dfa-income-levels.csv"),
                d3.csv("data/dfa-networth-levels.csv"),
                d3.csv("data/dfa-education-levels.csv"),
                d3.csv("data/dfa-generation-levels.csv")
            ])
            .then(([race, age, income, networth, education, generation]) => {
                raceData = race;
                ageData = age;
                incomeData = income;
                networthData = networth;
                educationData = education;
                generationData = generation;

                dataReady = true;
                console.log("All CSVs loaded successfully with Category column");
            });


            // RESIZE HANDLER
            window.addEventListener("resize", () => {
                if (!cachedStates) return;

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                projection.fitSize([width, height], cachedStates);

                svg.selectAll("circle")
                    .attr("cx", d => projection([d.lon, d.lat])[0])
                    .attr("cy", d => projection([d.lon, d.lat])[1]);
            });

            function updateLegend(categories, dataset, colorScale) {
                const legend = document.getElementById("legend");
                legend.innerHTML = "";

                categories.forEach(cat => {
                    const item = document.createElement("div");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "6px";

                    const swatch = document.createElement("div");
                    swatch.style.width = "14px";
                    swatch.style.height = "14px";
                    swatch.style.borderRadius = "3px";
                    swatch.style.backgroundColor = colorScale(cat);
                    swatch.style.border = "1px solid rgba(0,0,0,0.3)";

                    const label = document.createElement("span");
                    label.style.fontSize = "13px";
                    label.textContent = getLabel(cat, dataset);  // ⬅ use pretty label

                    item.appendChild(swatch);
                    item.appendChild(label);
                    legend.appendChild(item);
                });
            }


            // INITIAL DRAW OF 1000 DOTS
            function first_draw() {

                const width = svg.node().clientWidth;
                const height = svg.node().clientHeight;

                d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json")
                    .then(usData => {

                        const states = topojson.feature(usData, usData.objects.states);
                        cachedStates = states;

                        projection.fitSize([width, height], states);

                        const bounds = path.bounds(states);
                        const [[x0, y0], [x1, y1]] = bounds;
                        const area = (x1 - x0) * (y1 - y0);

                        const targetDots = 1000;
                        const spacing = Math.sqrt(area / targetDots);

                        const points = [];
                        for (let x = x0; x <= x1; x += spacing) {
                            for (let y = y0; y <= y1; y += spacing) {
                                const inverted = projection.invert([x, y]);
                                if (inverted && d3.geoContains(states, inverted)) {
                                    points.push({ lon: inverted[0], lat: inverted[1] });
                                }
                            }
                        }

                        if (points.length > targetDots) points.length = targetDots;

                        svg.selectAll("circle")
                            .data(points)
                            .enter()
                            .append("circle")
                            .attr("class", "circle")
                            .attr("cx", d => projection([d.lon, d.lat])[0])
                            .attr("cy", d => projection([d.lon, d.lat])[1])
                            .attr("fill", "#6fa3d6")
                            .attr("r", 0)
                            .transition()
                            .duration(400)
                            .attr("r", 8);
                    });
            }

            first_draw();


            function updateDots(dataset, targetYear = null) {

                if (!dataset || dataset.length === 0) return;

                // 1. Use target year if specified, otherwise use latest date
                let selectedRows;
                if (targetYear) {
                    // Find the first quarter of the target year (e.g., "1989:Q1" or "1989:Q3")
                    const yearPattern = new RegExp(`^${targetYear}:`);
                    const yearRows = dataset.filter(d => yearPattern.test(d.Date));
                    if (yearRows.length > 0) {
                        // Use the first available quarter of that year
                        const firstQuarter = d3.min(yearRows, d => d.Date);
                        selectedRows = dataset.filter(d => d.Date === firstQuarter);
                    } else {
                        // Fallback to latest if year not found
                        const latestDate = d3.max(dataset, d => d.Date);
                        selectedRows = dataset.filter(d => d.Date === latestDate);
                    }
                } else {
                    const latestDate = d3.max(dataset, d => d.Date);
                    selectedRows = dataset.filter(d => d.Date === latestDate);
                }
                let latestRows = selectedRows;

                // 2. Parse Net worth as numeric
                latestRows.forEach(d => {
                    d.NetWorth = +d["Net worth"];
                });

                if (dataset === networthData) {
                    const groupMap = {
                        "TopPt1": "Top 1%",
                        "RemainingTop1": "Top 1%",
                        "Next9": "Next 9%",
                        "Next40": "Next 40%",
                        "Bottom50": "Bottom 50%"
                    };

                    const grouped = d3.rollups(
                        latestRows,
                        v => d3.sum(v, d => d.NetWorth),
                        d => groupMap[d.Category]
                    );

                    // Rebuild as simple array of {Category, NetWorth}
                    latestRows = grouped.map(([Category, NetWorth]) => ({ Category, NetWorth }));
                }

                // 4. Compute totals, categories, proportions
                const totalNetWorth = d3.sum(latestRows, d => d.NetWorth);
                const categories = latestRows.map(d => d.Category);
                const proportions = latestRows.map(d => d.NetWorth / totalNetWorth);
                
                // Create a map of category to percentage for tooltip
                const categoryPercentages = new Map();
                latestRows.forEach((row, idx) => {
                    categoryPercentages.set(row.Category, proportions[idx]);
                });

                // 5. Color scale
                let color;

                if (dataset === networthData) {
                    // Explicit colors for grouped net-worth categories - using same palette as other visualizations
                    color = d3.scaleOrdinal()
                        .domain(categories)
                        .range(
                            categories.map(cat => {
                                if (cat === "Top 1%")     return "#d73027";  // top 1% – red
                                if (cat === "Next 9%")    return "#1a9850";  // next 9% – green
                                if (cat === "Next 40%")   return "#4575b4";  // next 40% – blue

                                if (cat === "Bottom 50%") return "#fee08b";  // bottom half – cream

                                return "#888888"; // fallback
                            })
                        );
                } else {
                    // Default palette for other dimensions
                    const baseColors = ["#d73027", "#1a9850", "#4575b4", "#fee08b", "#fc8d59", "#91bfdb"];
                    color = d3.scaleOrdinal()
                        .domain(categories)
                        .range(baseColors.slice(0, categories.length));
                }

                // 6. Get all circles and sort them by x-position
                const circlesSelection = svg.selectAll("circle");
                const nodes = circlesSelection.nodes();

                nodes.sort((a, b) => {
                    const ax = +a.getAttribute("cx");
                    const bx = +b.getAttribute("cx");
                    return ax - bx;
                });

                const totalDots = nodes.length;

                // 7. Decide how many dots each category gets (at least 1 each)
                let counts = proportions.map(p => Math.max(1, Math.round(p * totalDots)));

                let sumCounts = counts.reduce((a, b) => a + b, 0);
                while (sumCounts !== totalDots) {
                    const diff = totalDots - sumCounts;
                    counts[0] += diff;
                    sumCounts = counts.reduce((a, b) => a + b, 0);
                }

                // 8. Build a flat list of categories for each dot (in band order)
                const bandCategories = [];
                latestRows.forEach((row, idx) => {
                    const cat = row.Category;
                    const n = counts[idx];
                    for (let i = 0; i < n; i++) {
                        bandCategories.push(cat);
                    }
                });

                // 9. Assign categories to dots according to x-sorted order
                nodes.forEach((node, i) => {
                    const sel = d3.select(node);
                    if (i < bandCategories.length) {
                        const cat = bandCategories[i];
                        node.__data__.Category = cat;
                        sel.attr("visibility", "visible");
                    } else {
                        sel.attr("visibility", "hidden");
                    }
                });

                // 10. Animate colors
                svg.selectAll("circle")
                    .transition()
                    .duration(400)
                    .attr("fill", d => color(d.Category));

                // 11. Tooltip
                svg.selectAll("circle")
                    .on("mousemove", (event, d) => {
                        const label = getLabel(d.Category, dataset);
                        const percentage = categoryPercentages.get(d.Category);
                        const percentageText = percentage ? ` (${(percentage * 100).toFixed(1)}%)` : '';
                        tooltip.style("display", "block")
                            .style("left", event.pageX + "px")
                            .style("top", (event.pageY - 20) + "px")
                            .text(label + percentageText);
                    })
                    .on("mouseout", () => tooltip.style("display", "none"));

                // 12. Legend (now uses grouped categories for net worth)
                updateLegend(categories, dataset, color);
            }


            // BUTTON HANDLERS
            function setActive(btnId) {
                document.querySelectorAll(".controls button").forEach(b => b.classList.remove("active"));
                document.querySelector(btnId).classList.add("active");
            }

            btnEdu.onclick = () => {
                setActive("#btnEdu");
                description.innerHTML = `
                    <strong>Many people begin with the belief that education neatly predicts financial outcomes.</strong>
                    Diplomas seem like clear markers of stability: high school, college, and graduate degrees appear to form 
                    a simple ladder of economic mobility. Yet when we map wealth across educational groups, the pattern 
                    becomes more complex. Even though additional schooling is associated with higher earnings, the wealth 
                    that households hold varies far more widely than expected. This first view suggests that education 
                    matters, but it is only the starting point for understanding how wealth actually accumulates in the U.S.

            `;
                map_title.textContent = "Distribution of Wealth by Education";
                updateDots(educationData);
            };

            btnAge.onclick = () => {
                setActive("#btnAge");
                description.innerHTML = `
                <strong>Age adds a natural progression to the story, since people typically build assets as they grow 
                older.</strong> The data reveals this relationship is far from uniform. Younger and older groups hold vastly 
                different shares of national wealth, and the distribution doesn’t mirror what we saw with education. This 
                contrast shows that wealth is shaped not just by personal achievements but by life stages, timing, and 
                long-term financial cycles. As we move beyond age, the picture becomes even less predictable.
            `;
                map_title.textContent = "Distribution of Wealth by Age";
                updateDots(ageData);
            };

                
            btnInc.onclick = () => {
                setActive("#btnInc");
                description.innerHTML = `
                    <strong>Income adds another familiar lens, since many assume higher earnings naturally lead to higher wealth.</strong>
                    But when we visualize the distribution, the pattern looks very different from what education or age suggested. 
                    Wealth does not rise proportionally with income categories. Instead, the spread shows that yearly earnings capture 
                    only one part of a household’s financial position. This view highlights that income reflects what flows in each 
                    year, while wealth reflects what accumulates over many years.
                `;
                map_title.textContent = "Distribution of Wealth by Income";
                updateDots(incomeData);
            };

            btnGen.onclick = () => {
                setActive("#btnGen");
                description.innerHTML = `
                    <strong>Looking at generations shifts the story from individual circumstances to broader historical 
                    patterns.</strong> Each generation entered adulthood under different economic conditions, shaping the 
                    opportunities available to build and maintain wealth. Even though there are reasonably similar numbers of 
                    Americans within the Baby Boomer, Gen X, and Millenial generations, their share of wealth are drastically
                    different. The resulting distribution doesn't resemble the patterns of education, age, or income. It reflects 
                    the influence of economic eras, major shifts in policy, housing markets, and financial systems. This nuanced 
                    view shows that wealth is not only personal but also contextual.
                `;
                map_title.textContent = "Distribution of Wealth by Generation";
                updateDots(generationData);
            };

            btnRace.onclick = () => {
                setActive("#btnRace");
                description.innerHTML = `
                    <strong>Examining wealth by racial groups reveals yet another pattern that reshapes our understanding 
                        of the data.</strong> Unlike the previous categories, this distribution reflects long-term demographic 
                        trends rather than life stages or income levels. For example, white Americans make up approximately 60%
                        of the U.S. population but hold over 84% of the country's wealth, setting them at a clearly disproportionate
                        advantage. Meanwhile, black Americans make up approximately 14% of the population but hold around 4% of the
                        country's wealth. The differences across racial groups highlight how identity contributes to national 
                        wealth shares and demonstrate that multiple identity and contextual factors push individuals into different
                        wealth opportunities. 
                `;
                map_title.textContent = "Distribution of Wealth by Race";
                updateDots(raceData);
            };

            btnNW.onclick = () => {
                setActive("#btnNW");
                description.innerHTML = `
                    <strong>With all perspectives in mind, the net worth view brings the entire story into focus.</strong>
                    Unlike the earlier dimensions, which revealed different slices of the population, this distribution shows 
                    the full structure of wealth in the U.S. at once. The orange dots display the wealth share of the top 50%
                    and the corresponding top 10% and 1%, while the blue demonstrates the wealth of the bottom 50%. We can clearly
                    see how concentrated national wealth has become, with a small share of households holding a disproportionately 
                    large portion of the total. Therefore, by moving through each demographic lens and ending here, the visualization 
                    reveals how complex and interconnected the drivers of wealth truly are far beyond any single variable: Every part 
                    of an American's identity matters and influences how they are set up to hold wealth in America.
                `;
                map_title.textContent = "Distribution of Wealth by Net Worth";
                updateDots(networthData);
            };

            btnNW1989.onclick = () => {
                setActive("#btnNW1989");
                description.innerHTML = `
                    <strong>Looking back to 1989, we can see how wealth distribution has changed over time.</strong>
                    This historical view shows the net worth distribution at the earliest point in our dataset, allowing us to 
                    compare how wealth concentration has evolved. The same color scheme applies: red for the top 1%, green for the 
                    next 9%, blue for the next 40%, and cream for the bottom 50%. By comparing this view with the current net 
                    worth distribution, we can observe the trends in wealth inequality over the past three decades.
                `;
                map_title.textContent = "Distribution of Wealth by Net Worth (1989)";
                updateDots(networthData, "1989");
            };

        </script>

    </body>
</html>